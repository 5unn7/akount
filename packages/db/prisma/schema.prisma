generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Tenancy & Users
// ============================================================================

model Tenant {
  id          String       @id @default(cuid())
  name        String
  region      String       // 'CA' | 'US' | 'EU' etc.
  status      String       // 'trial' | 'active' | 'past_due' | 'closed'
  plan        String       // 'free' | 'pro' | 'enterprise'
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  entities    Entity[]
  memberships TenantUser[]
  auditLogs   AuditLog[]
  events      DomainEvent[]
  importBatches ImportBatch[]
  accountingPolicies AccountingPolicy[]
}

model TenantUser {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String   // 'owner' | 'admin' | 'accountant' | 'viewer'
  createdAt DateTime @default(now())

  @@unique([tenantId, userId])
}

// User model for Auth/Roles (simplified for now)
model User {
  id        String       @id @default(cuid())
  email     String       @unique
  name      String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  memberships TenantUser[]
  auditLogs  AuditLog[]
}

// ============================================================================
// Core Accounting Backbone
// ============================================================================

model Entity {
  id             String           @id @default(cuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id])

  name           String
  type           String // 'personal' | 'corporation' | 'llc' | 'partnership'
  country        String
  taxId          String?
  functionalCurrency String       // e.g. 'CAD'
  reportingCurrency  String       // default reporting currency

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  glAccounts     GLAccount[]
  journalEntries JournalEntry[]
  clients        Client[]
  invoices       Invoice[]
  vendors        Vendor[]
  bills          Bill[]
  payments       Payment[]
  accounts       Account[]
  budgets        Budget[]
  goals          Goal[]
  insights       Insight[]
  rules          Rule[]
  projects       Project[]
  BankConnection BankConnection[]
  CreditNote     CreditNote[]
  TaxRate        TaxRate[]
  FiscalCalendar FiscalCalendar[]
  auditLogs      AuditLog[]
  events         DomainEvent[]
  importBatches  ImportBatch[]
  accountingPolicies AccountingPolicy[]
}

model GLAccount {
  id              String        @id @default(cuid())
  entityId        String
  entity          Entity        @relation(fields: [entityId], references: [id])
  code            String
  name            String
  type            String // 'asset' | 'liability' | 'equity' | 'income' | 'expense'
  normalBalance   String // 'debit' | 'credit'
  description     String?
  parentAccountId String?
  parentAccount   GLAccount?    @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  childAccounts   GLAccount[]   @relation("AccountHierarchy")
  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  journalLines    JournalLine[]
  invoiceLines    InvoiceLine[]
  billLines       BillLine[]

  @@unique([entityId, code])
}

model JournalEntry {
  id           String        @id @default(cuid())
  entityId     String
  entity       Entity        @relation(fields: [entityId], references: [id])
  date         DateTime
  memo         String
  sourceType   String?
  sourceId     String?
  status       String // 'draft' | 'posted'
  createdBy    String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  journalLines JournalLine[]
}

model JournalLine {
  id             String       @id @default(cuid())
  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id])
  glAccountId    String
  glAccount      GLAccount    @relation(fields: [glAccountId], references: [id])
  debitAmount    Int // Integer cents
  creditAmount   Int // Integer cents
  memo           String?
}

model TaxRate {
  id            String   @id @default(cuid())
  entityId      String?  // Nullable for global tax rates
  Entity        Entity?  @relation(fields: [entityId], references: [id])
  code          String
  name          String
  rate          Float    // Percentage (e.g. 5.0 for 5%)
  jurisdiction  String
  isInclusive   Boolean
  glAccountId   String?
  isActive      Boolean
  effectiveFrom DateTime
  effectiveTo   DateTime?
}

model FiscalCalendar {
  id        String         @id @default(cuid())
  entityId  String
  Entity    Entity         @relation(fields: [entityId], references: [id])
  year      Int
  startDate DateTime
  endDate   DateTime
  periods   FiscalPeriod[]
}

model FiscalPeriod {
  id               String         @id @default(cuid())
  fiscalCalendarId String
  FiscalCalendar   FiscalCalendar @relation(fields: [fiscalCalendarId], references: [id])
  periodNumber     Int
  name             String
  startDate        DateTime
  endDate          DateTime
  status           String // 'open' | 'locked'
}

// ============================================================================
// Accounts Receivable & Payable
// ============================================================================

model Client {
  id           String    @id @default(cuid())
  entityId     String
  entity       Entity    @relation(fields: [entityId], references: [id])
  name         String
  email        String?
  phone        String?
  address      String?
  paymentTerms String?
  status       String    @default("active") // 'active' | 'inactive'
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  invoices     Invoice[]
  Payment      Payment[]
}

model Invoice {
  id            String        @id @default(cuid())
  entityId      String
  entity        Entity        @relation(fields: [entityId], references: [id])
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id])
  invoiceNumber String
  issueDate     DateTime
  dueDate       DateTime
  currency      String
  subtotal      Int  // Integer cents
  taxAmount     Int  // Integer cents
  total         Int  // Integer cents
  status        String // 'draft' | 'sent' | 'paid' | 'overdue' | 'cancelled'
  paidAmount    Int  // Integer cents
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  invoiceLines  InvoiceLine[]
}

model InvoiceLine {
  id           String    @id @default(cuid())
  invoiceId    String
  invoice      Invoice   @relation(fields: [invoiceId], references: [id])
  description  String
  quantity     Int       // simple int
  unitPrice    Int       // Integer cents
  taxRateId    String?
  taxAmount    Int       // Integer cents
  amount       Int       // Integer cents
  glAccountId  String?
  glAccount    GLAccount? @relation(fields: [glAccountId], references: [id])
  categoryId   String?
  category     Category? @relation(fields: [categoryId], references: [id])
}

model Vendor {
  id           String    @id @default(cuid())
  entityId     String
  entity       Entity    @relation(fields: [entityId], references: [id])
  name         String
  email        String?
  phone        String?
  address      String?
  paymentTerms String?
  status       String    @default("active")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  bills        Bill[]
  Payment      Payment[]
}

model Bill {
  id         String     @id @default(cuid())
  entityId   String
  entity     Entity     @relation(fields: [entityId], references: [id])
  vendorId   String
  vendor     Vendor     @relation(fields: [vendorId], references: [id])
  billNumber String
  issueDate  DateTime
  dueDate    DateTime
  currency   String
  subtotal   Int
  taxAmount  Int
  total      Int
  status     String
  paidAmount Int
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  billLines  BillLine[]
}

model BillLine {
  id          String     @id @default(cuid())
  billId      String
  bill        Bill       @relation(fields: [billId], references: [id])
  description String
  quantity    Int
  unitPrice   Int
  taxRateId   String?
  taxAmount   Int
  amount      Int
  glAccountId String?
  glAccount   GLAccount? @relation(fields: [glAccountId], references: [id])
  categoryId  String?
  category    Category?  @relation(fields: [categoryId], references: [id])
}

model Payment {
  id            String    @id @default(cuid())
  entityId      String
  entity        Entity    @relation(fields: [entityId], references: [id])
  date          DateTime
  amount        Int
  currency      String
  paymentMethod String // 'card' | 'transfer' | 'cash' | 'check'
  reference     String?
  clientId      String?
  client        Client?   @relation(fields: [clientId], references: [id])
  vendorId      String?
  vendor        Vendor?   @relation(fields: [vendorId], references: [id])
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model CreditNote {
  id               String   @id @default(cuid())
  entityId         String
  Entity           Entity   @relation(fields: [entityId], references: [id])
  creditNoteNumber String
  date             DateTime
  currency         String
  amount           Int
  reason           String
  linkedInvoiceId  String?
  linkedBillId     String?
  status           String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ============================================================================
// Banking, Feeds & Reconciliation
// ============================================================================

model Account {
  id             String                @id @default(cuid())
  entityId       String
  entity         Entity                @relation(fields: [entityId], references: [id])
  name           String
  type           String // 'bank' | 'credit_card' | 'loan' | 'mortgage' | 'investment' | 'other'
  institution    String?
  currency       String
  country        String
  currentBalance Int
  isActive       Boolean               @default(true)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  transactions   Transaction[]
  feedTxns       BankFeedTransaction[]
}

model BankConnection {
  id              String                @id @default(cuid())
  entityId        String
  Entity          Entity                @relation(fields: [entityId], references: [id])
  provider        String                // 'flinks' | 'plaid' | 'manual'
  providerItemId  String?
  institutionId   String
  institutionName String
  status          String                // 'active' | 'error' | 'disconnected'
  lastSyncAt      DateTime?
  errorMessage    String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  feedTxns        BankFeedTransaction[]
}

model BankFeedTransaction {
  id                String              @id @default(cuid())
  bankConnectionId  String
  BankConnection    BankConnection      @relation(fields: [bankConnectionId], references: [id])
  accountId         String
  Account           Account             @relation(fields: [accountId], references: [id])
  bankTransactionId String
  date              DateTime
  description       String
  amount            Int
  currency          String
  balance           Int?
  createdAt         DateTime            @default(now())
  TransactionMatch  TransactionMatch[]
}

model Transaction {
  id              String             @id @default(cuid())
  accountId       String
  account         Account            @relation(fields: [accountId], references: [id])
  date            DateTime
  description     String
  amount          Int
  currency        String
  categoryId      String?
  category        Category?          @relation(fields: [categoryId], references: [id])
  notes           String?
  sourceType      String // 'bank_feed' | 'manual' | 'invoice' | 'bill'
  sourceId        String?
  journalEntryId  String?
  isSplit         Boolean            @default(false)
  splits          TransactionSplit[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  matches         TransactionMatch[]
  importBatchId   String?
  importBatch     ImportBatch?       @relation(fields: [importBatchId], references: [id])
}

model TransactionSplit {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  amount        Int
  categoryId    String?
  category      Category?   @relation(fields: [categoryId], references: [id])
  description   String?
  notes         String?
  projectId     String?
  tags          String? // JSON string array? or simple string
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model TransactionMatch {
  id                    String              @id @default(cuid())
  bankFeedTransactionId String
  BankFeedTransaction   BankFeedTransaction @relation(fields: [bankFeedTransactionId], references: [id])
  transactionId         String?
  Transaction           Transaction?        @relation(fields: [transactionId], references: [id])
  journalEntryId        String?
  status                String // 'matched' | 'suggested' | 'unmatched'
  confidence            Float?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
}

model Category {
  id               String             @id @default(cuid())
  name             String
  type             String // 'income' | 'expense' | 'transfer'
  parentCategoryId String?
  parentCategory   Category?          @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories  Category[]         @relation("CategoryHierarchy")
  color            String?
  isActive         Boolean            @default(true)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  transactions     Transaction[]
  invoiceLines     InvoiceLine[]
  billLines        BillLine[]
  TransactionSplit TransactionSplit[]
  Budget           Budget[]
  Goal             Goal[]
  Snapshot         Snapshot[]
}

// ============================================================================
// Budgeting, Goals & Analytics
// ============================================================================

model Budget {
  id          String    @id @default(cuid())
  entityId    String
  Entity      Entity    @relation(fields: [entityId], references: [id])
  name        String
  categoryId  String?
  Category    Category? @relation(fields: [categoryId], references: [id])
  glAccountId String?
  amount      Int
  period      String
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Goal {
  id            String    @id @default(cuid())
  entityId      String
  Entity        Entity    @relation(fields: [entityId], references: [id])
  name          String
  type          String
  targetAmount  Int
  currentAmount Int
  targetDate    DateTime
  accountId     String?
  categoryId    String?
  Category      Category? @relation(fields: [categoryId], references: [id])
  status        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Insight {
  id          String   @id @default(cuid())
  entityId    String
  Entity      Entity   @relation(fields: [entityId], references: [id])
  triggerId   String
  title       String
  description String
  type        String
  priority    String
  impact      Int?
  confidence  Float?
  actionable  Boolean
  status      String
  deadline    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Rule {
  id         String   @id @default(cuid())
  entityId   String
  Entity     Entity   @relation(fields: [entityId], references: [id])
  name       String
  conditions String // JSON
  action     String // JSON
  isActive   Boolean
  source     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model Project {
  id          String   @id @default(cuid())
  entityId    String
  Entity      Entity   @relation(fields: [entityId], references: [id])
  name        String
  code        String
  description String?
  status      String
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Snapshot {
  id          String    @id @default(cuid())
  entityId    String
  date        DateTime
  glAccountId String?
  categoryId  String?
  Category    Category? @relation(fields: [categoryId], references: [id])
  balance     Int
  createdAt   DateTime  @default(now())
}

// ============================================================================
// FX, Audit, Events, Import, Policies
// ============================================================================

model FXRate {
  id        String   @id @default(cuid())
  base      String   // 'CAD'
  quote     String   // 'USD'
  date      DateTime
  source    String   // 'ECB' | 'BOC' | 'manual'
  rate      Float
  createdAt DateTime @default(now())

  @@unique([base, quote, date, source])
}

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  entityId  String?
  entity    Entity?  @relation(fields: [entityId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  model     String   // 'JournalEntry' | 'Transaction' | ...
  recordId  String
  action    String   // 'create' | 'update' | 'delete'
  before    String?  // JSON
  after     String?  // JSON
  createdAt DateTime @default(now())
}

model DomainEvent {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  entityId    String?
  entity      Entity?  @relation(fields: [entityId], references: [id])
  type        String   // 'TransactionPosted' | 'PeriodClosed' | ...
  aggregateId String?
  aggregate   String?  // 'JournalEntry' | 'Transaction' | ...
  payload     String   // JSON
  createdAt   DateTime @default(now())
  processedAt DateTime?
}

model ImportBatch {
  id         String    @id @default(cuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  entityId   String?
  entity     Entity?   @relation(fields: [entityId], references: [id])
  sourceType String    // 'csv' | 'pdf' | 'bank_feed'
  status     String    // 'pending' | 'processed' | 'failed'
  error      String?
  createdAt  DateTime  @default(now())
  Transactions Transaction[]
}

model AccountingPolicy {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  entityId      String?
  entity        Entity?  @relation(fields: [entityId], references: [id])
  key           String   // 'revenue_recognition_method', 'fx_method', etc.
  value         String   // JSON or simple string/number
  effectiveFrom DateTime
  effectiveTo   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
