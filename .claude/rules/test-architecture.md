# Test Architecture

---
paths:
  - "**/__tests__/**"
  - "**/*.test.ts"
  - "**/*.test.tsx"
---

> **Auto-loaded for all test files** - Enforces schema-driven factory pattern

---

## Golden Rule: Factories First, Never Inline

EVERY test MUST use generated factories from `__generated__/fabbrica/` or validated input factories from `test-utils/input-factories`.

**Why:** Schema changes should update ONE factory, not 76 test files.

---

## Two-Layer Factory Pattern

### Layer 1: Prisma Model Factories (Auto-Generated)

**Use:** When mocking Prisma responses (service tests)

```typescript
import { AccountFactory, InvoiceFactory } from '../__generated__/fabbrica';

// Generate Prisma model mocks
const account = await AccountFactory.build({ name: 'Checking' });
const invoice = await InvoiceFactory.build({
  invoiceNumber: 'INV-001',
  client: await ClientFactory.build({ name: 'Acme' }),
});

// Use in mock
mockPrisma.account.findFirst.mockResolvedValue(account);
```

**Generated by:** `npx prisma generate` (prisma-fabbrica)
**Source:** `packages/db/prisma/schema.prisma`
**Output:** `apps/api/src/__generated__/fabbrica/index.ts`

---

### Layer 2: Zod Input Factories (Validated)

**Use:** When testing API routes with Zod validation

```typescript
import { mockTaxRateInput, mockInvoiceInput } from '../../test-utils/input-factories';

// Create validated API input
const input = mockTaxRateInput({ code: 'HST', rateBasisPoints: 1300 });

// Input is validated against CreateTaxRateSchema
await service.createTaxRate(input, CTX);
```

**Validated by:** `CreateSchema.parse()` in factory
**Source:** `apps/api/src/domains/*/schemas/*.schema.ts`
**Output:** `apps/api/src/test-utils/input-factories.ts`

---

## Factory Selection Guide

| Test Scenario | Use This | Example |
|---------------|----------|---------|
| Mock Prisma query result | Prisma factory | `mockPrisma.account.findFirst.mockResolvedValue(await AccountFactory.build())` |
| Test API route input | Input factory | `const input = mockInvoiceInput(); await createInvoice(input)` |
| Flow test (create → read) | Both | Input factory for create, Prisma factory for mock read |
| Nested relations | Prisma factory | `InvoiceFactory.build({ client: await ClientFactory.build() })` |

---

## Mandatory Patterns

### ✅ Pattern 1: Import Generated Factories

```typescript
// For service tests (Prisma mocks)
import {
  AccountFactory,
  TransactionFactory,
  InvoiceFactory,
} from '../__generated__/fabbrica';

// For route tests (API inputs)
import {
  mockAccountInput,
  mockInvoiceInput,
  mockTaxRateInput,
} from '../../test-utils/input-factories';

// Shared utilities
import { TEST_IDS } from '../../test-utils';
```

---

### ✅ Pattern 2: Build with Minimal Overrides

```typescript
// Only override fields relevant to the test
const account = await AccountFactory.build({ name: 'Checking' });
// All other fields auto-generated with realistic defaults
```

---

### ✅ Pattern 3: Relations via Factories

```typescript
// Nested relations
const invoice = await InvoiceFactory.build({
  client: await ClientFactory.build({ name: 'Acme Corp' }),
  invoiceLines: await InvoiceLineFactory.buildList(3, {
    taxRate: await TaxRateFactory.build({ rateBasisPoints: 500 }),
  }),
});
```

---

### ✅ Pattern 4: Multiple Instances with buildList

```typescript
// Create array of mocks
const accounts = await AccountFactory.buildList(5, { type: 'BANK' });
// Generates 5 unique accounts with different IDs, names, etc.
```

---

## Anti-Patterns (BLOCKED)

### ❌ NEVER: Inline Mock Objects

```typescript
// ❌ WRONG - Breaks when TaxRate schema changes
const taxRate = {
  id: 'tax-1',
  code: 'GST',
  rate: 5, // Wrong field (should be rateBasisPoints)
  jurisdiction: 'Canada',
  isActive: true,
  effectiveFrom: new Date(),
  effectiveTo: null,
  createdAt: new Date(),
  updatedAt: new Date(),
};
```

**Fix:**
```typescript
// ✅ CORRECT
import { TaxRateFactory } from '../__generated__/fabbrica';
const taxRate = await TaxRateFactory.build({ code: 'GST', rateBasisPoints: 500 });
```

---

### ❌ NEVER: Module-Level Constants

```typescript
// ❌ WRONG - Data becomes stale, drift from schema
const MOCK_ACCOUNT = { id: 'acc-1', name: 'Checking', /* ... */ };

describe('Tests', () => {
  it('test 1', () => {
    mockPrisma.account.findFirst.mockResolvedValue(MOCK_ACCOUNT);
  });
});
```

**Fix:**
```typescript
// ✅ CORRECT - Generate fresh data per test
describe('Tests', () => {
  it('test 1', async () => {
    const account = await AccountFactory.build({ name: 'Checking' });
    mockPrisma.account.findFirst.mockResolvedValue(account);
  });
});
```

---

### ❌ NEVER: Helper Functions for Mocks

```typescript
// ❌ WRONG - Duplicates factory logic
function makeMockAccount(name: string) {
  return {
    id: 'acc-1',
    name,
    type: 'BANK',
    // ... manually maintained
  };
}
```

**Fix:**
```typescript
// ✅ CORRECT - Use factory directly
const account = await AccountFactory.build({ name: 'Checking' });
```

---

### ❌ NEVER: Spread Manual Objects

```typescript
// ❌ WRONG - Still inline, just with spread
const BASE_INVOICE = { id: 'inv-1', total: 1000, /* ... */ };
const invoice1 = { ...BASE_INVOICE, invoiceNumber: 'INV-001' };
```

**Fix:**
```typescript
// ✅ CORRECT
const invoice1 = await InvoiceFactory.build({ invoiceNumber: 'INV-001' });
```

---

## Schema Change Workflow

### Old (Broken)
1. Change Prisma schema (e.g., `rate Float → rateBasisPoints Int`)
2. 76 test files break with type errors
3. Manually update each inline mock
4. Miss some → CI fails
5. 2-3h wasted

### New (Automatic)
1. Change Prisma schema
2. Run `npx prisma generate` → factories regenerate
3. TypeScript errors if factory defaults invalid
4. Fix factory default (ONE line)
5. All tests auto-fix → 10min total

---

## Creating New Test Files

### Use Template

```bash
cp apps/api/src/test-utils/templates/service.test.template.ts \
   apps/api/src/domains/myDomain/__tests__/myService.service.test.ts
```

### Required Elements

Every new test file MUST have:

1. **Prisma factory imports** (if mocking Prisma)
2. **Input factory imports** (if testing API routes)
3. **TEST_IDS import** for consistent test data
4. **mockPrisma import** (centralized mock)
5. **rewirePrismaMock() in beforeEach** (transaction support)

**Example structure:**
```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { mockPrisma, rewirePrismaMock, TEST_IDS } from '../../../../test-utils';
import { ResourceFactory } from '../../../../__generated__/fabbrica';
import { mockResourceInput } from '../../../../test-utils/input-factories';

vi.mock('@akount/db', async (importOriginal) => ({
  ...(await importOriginal<Record<string, unknown>>()),
  prisma: (await import('../../../../test-utils/prisma-mock')).mockPrisma,
}));

describe('ResourceService', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    rewirePrismaMock();
  });

  it('should create resource', async () => {
    const input = mockResourceInput({ name: 'Test' });
    const created = await ResourceFactory.build({ name: input.name });

    mockPrisma.resource.create.mockResolvedValueOnce(created);

    const result = await service.createResource(input, CTX);
    expect(result.name).toBe('Test');
  });
});
```

---

## When Schema Changes

### Developer Workflow

1. **Edit Prisma schema** (e.g., add field, change type)
2. **Run factory generation:**
   ```bash
   cd packages/db
   npx prisma generate
   ```
3. **Check TypeScript errors:**
   ```bash
   cd apps/api
   npx tsc --noEmit
   ```
4. **If factory defaults invalid:** Update factory default in one place
5. **Verify tests:** `npm run test`

### What Auto-Updates

- ✅ Generated factory types match new schema
- ✅ Faker generators update for new fields
- ✅ TypeScript catches invalid factory defaults
- ✅ Tests using factories auto-fix

### What Requires Manual Fix

- ⚠️ Factory default values (if new required field added)
- ⚠️ Input factories (update `input-factories.ts` defaults)
- ⚠️ Tests asserting on removed fields (rare)

---

## Enforcement

### Pre-Commit Hook

`.claude/hooks/test-factory-enforce.sh` validates:
- New test files import factories
- No inline mocks committed
- Factory imports from correct paths

### ESLint Rule

Warns on object literals with >3 properties in test files.

### Test Architecture Reviewer Agent

Run `/processes:review` on test files to validate:
- Factory usage compliance
- No deprecated patterns
- Minimal specification
- Type safety

---

## Migration Status

**Target:** 100% factory adoption (154 test files)

**Current progress tracked in:**
```bash
node .claude/scripts/audit-factory-usage.sh
```

---

## Checklist for New Test Files

Before committing a test file:

- [ ] Imports factories (Prisma or input)
- [ ] No inline object literals with >3 properties
- [ ] Uses `TEST_IDS` for consistent test data
- [ ] Imports `mockPrisma` from centralized location
- [ ] No `as any` type casts
- [ ] Minimal field overrides (only what test cares about)
- [ ] Relations use factories (not manual objects)
- [ ] Passes `npx eslint` (no inline mock warnings)

---

_Created: 2026-02-28. Enforces factory-first testing pattern across 2000+ tests._
