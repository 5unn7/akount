# Akount Architecture Diagrams

> **Last Updated:** 2026-02-07
> **Render:** VS Code, GitHub, or any Mermaid-compatible viewer

---

## 1. System Overview

High-level architecture showing services, modules, and boundaries.

```mermaid
flowchart TB
    subgraph Client["Client Layer"]
        Browser["Browser (Next.js App)"]
        Mobile["Mobile (Future)"]
    end

    subgraph Auth["Authentication"]
        Clerk["Clerk (Auth Provider)"]
        JWT["JWT Tokens"]
    end

    subgraph Frontend["Frontend (apps/web)"]
        NextJS["Next.js 16 (App Router)"]
        RSC["React Server Components"]
        CC["Client Components"]

        subgraph Pages["Pages by Domain"]
            Overview["Overview"]
            MoneyMove["Money Movement"]
            Business["Business"]
            Accounting["Accounting"]
            Planning["Planning"]
            AIAdvisor["AI Advisor"]
            Services["Services"]
            System["System"]
        end
    end

    subgraph Backend["Backend (apps/api)"]
        Fastify["Fastify Server"]

        subgraph Middleware["Middleware"]
            AuthMW["Auth Middleware"]
            TenantMW["Tenant Middleware"]
            ValidMW["Validation (Zod)"]
        end

        subgraph Domains["Domain Services"]
            InvoiceSvc["Invoice Service"]
            PaymentSvc["Payment Service"]
            AccountSvc["Account Service"]
            EntitySvc["Entity Service"]
            TransactionSvc["Transaction Service"]
            JournalSvc["Journal Service"]
            AISvc["AI Service"]
        end
    end

    subgraph Data["Data Layer"]
        Prisma["Prisma ORM"]
        PostgreSQL["PostgreSQL Database"]
        Redis["Redis (Cache/Queue)"]
    end

    subgraph External["External Services"]
        Plaid["Plaid (Bank Connect)"]
        OpenAI["OpenAI (AI)"]
        Resend["Resend (Email)"]
        Stripe["Stripe (Payments)"]
    end

    Browser --> Clerk
    Browser --> NextJS
    Mobile -.-> Clerk

    Clerk --> JWT
    JWT --> AuthMW

    NextJS --> RSC
    RSC --> CC
    RSC --> Fastify

    Fastify --> AuthMW
    AuthMW --> TenantMW
    TenantMW --> ValidMW
    ValidMW --> Domains

    Domains --> Prisma
    Prisma --> PostgreSQL
    Domains --> Redis

    Domains --> Plaid
    AISvc --> OpenAI
    Domains --> Resend
    Domains --> Stripe

    classDef frontend fill:#4A90D9,stroke:#333,color:#fff
    classDef backend fill:#2E7D32,stroke:#333,color:#fff
    classDef data fill:#9C27B0,stroke:#333,color:#fff
    classDef external fill:#FF9800,stroke:#333,color:#fff
    classDef auth fill:#E53935,stroke:#333,color:#fff

    class Browser,NextJS,RSC,CC frontend
    class Fastify,Domains backend
    class Prisma,PostgreSQL,Redis data
    class Plaid,OpenAI,Resend,Stripe external
    class Clerk,JWT auth
```

---

## 2. Request Flow

Sequence diagram showing a typical authenticated API request.

```mermaid
sequenceDiagram
    autonumber
    participant Browser
    participant Clerk
    participant NextJS as Next.js (RSC)
    participant API as Fastify API
    participant AuthMW as Auth Middleware
    participant TenantMW as Tenant Middleware
    participant Valid as Zod Validation
    participant Service as Domain Service
    participant Prisma
    participant DB as PostgreSQL

    Browser->>Clerk: 1. Authenticate (Passkey/OAuth)
    Clerk-->>Browser: JWT Token

    Browser->>NextJS: 2. Page Request
    NextJS->>NextJS: Check auth (Clerk middleware)

    NextJS->>API: 3. API Call with JWT

    API->>AuthMW: 4. Verify JWT
    AuthMW->>Clerk: Validate token
    Clerk-->>AuthMW: User claims
    AuthMW->>AuthMW: Extract userId, email

    AuthMW->>TenantMW: 5. Resolve tenant
    TenantMW->>Prisma: Find tenant membership
    Prisma->>DB: SELECT tenant_id WHERE user_id = ?
    DB-->>Prisma: tenantId, role
    Prisma-->>TenantMW: TenantContext
    TenantMW->>TenantMW: Attach to request

    TenantMW->>Valid: 6. Validate request body
    Valid->>Valid: Parse with Zod schema

    alt Validation Failed
        Valid-->>API: 400 Bad Request
        API-->>Browser: Error response
    end

    Valid->>Service: 7. Execute business logic
    Service->>Prisma: Query with tenantId filter

    Note over Prisma,DB: ALWAYS filter by tenantId

    Prisma->>DB: SELECT * WHERE tenant_id = ?
    DB-->>Prisma: Results
    Prisma-->>Service: Typed data

    Service->>Service: Business logic
    Service-->>API: Response DTO

    API-->>NextJS: 8. JSON response
    NextJS-->>Browser: 9. Rendered page
```

---

## 3. Transaction State Machine

Bank transaction lifecycle from import to reconciliation.

```mermaid
stateDiagram-v2
    [*] --> Imported: Bank sync / CSV import

    Imported --> Categorized: AI categorization
    Imported --> NeedsReview: Low confidence / Rule conflict

    NeedsReview --> Categorized: User confirms category
    NeedsReview --> Excluded: User marks as personal / duplicate

    Categorized --> Matched: Match to invoice/bill
    Categorized --> Unmatched: No match found

    Unmatched --> Matched: User creates match
    Unmatched --> Standalone: User confirms standalone

    Matched --> Reconciled: Verify amounts match
    Standalone --> Reconciled: Post to GL

    Reconciled --> Posted: Journal entry created

    Posted --> [*]: Complete

    Excluded --> [*]: Ignored

    note right of Imported
        Raw bank data
        - amount (cents)
        - date
        - description
        - rawData (JSON)
    end note

    note right of Categorized
        AI-assigned:
        - category
        - glAccountId
        - confidence score
    end note

    note right of Reconciled
        Verified:
        - amounts match
        - dates align
        - no duplicates
    end note

    note right of Posted
        Journal Entry:
        - debits = credits
        - sourceDocument saved
        - audit trail complete
    end note
```

**Transaction Status Values:**
| Status | Description |
|--------|-------------|
| `IMPORTED` | Raw data from bank, needs processing |
| `NEEDS_REVIEW` | AI uncertain, requires human decision |
| `CATEGORIZED` | Category assigned, ready for matching |
| `MATCHED` | Linked to invoice/bill/transfer |
| `UNMATCHED` | No match found, standalone transaction |
| `RECONCILED` | Verified and ready for posting |
| `POSTED` | Journal entry created, books updated |
| `EXCLUDED` | Marked as personal/duplicate, ignored |

---

## 4. Invoice Lifecycle

Invoice progression from creation to settlement.

```mermaid
stateDiagram-v2
    [*] --> Draft: Create invoice

    Draft --> Draft: Edit details
    Draft --> Sent: Send to client

    Sent --> Viewed: Client opens
    Sent --> Overdue: Past due date

    Viewed --> Overdue: Past due date
    Viewed --> PartialPaid: Partial payment received
    Viewed --> Paid: Full payment received

    Overdue --> PartialPaid: Partial payment
    Overdue --> Paid: Full payment
    Overdue --> WrittenOff: Bad debt

    PartialPaid --> Paid: Remaining payment
    PartialPaid --> WrittenOff: Bad debt

    Paid --> [*]: Complete

    Draft --> Void: Cancel before send
    Sent --> Void: Cancel with credit
    Void --> [*]: Cancelled

    WrittenOff --> [*]: Closed

    note right of Draft
        - No GL impact
        - Editable
        - Not visible to client
    end note

    note right of Sent
        Journal Entry:
        DR: Accounts Receivable
        CR: Revenue
    end note

    note right of Paid
        Journal Entry:
        DR: Cash/Bank
        CR: Accounts Receivable
    end note

    note right of Void
        Reversal Entry:
        DR: Revenue
        CR: Accounts Receivable
    end note

    note right of WrittenOff
        Journal Entry:
        DR: Bad Debt Expense
        CR: Accounts Receivable
    end note
```

**Invoice Status Values:**
| Status | GL Impact | Editable | Client Visible |
|--------|-----------|----------|----------------|
| `DRAFT` | None | Yes | No |
| `SENT` | AR + Revenue | No | Yes |
| `VIEWED` | None (already posted) | No | Yes |
| `OVERDUE` | None (already posted) | No | Yes |
| `PARTIAL_PAID` | Cash + AR partial | No | Yes |
| `PAID` | Cash + AR cleared | No | Yes |
| `VOID` | Reversal entry | No | No |
| `WRITTEN_OFF` | Bad debt entry | No | No |

---

## 5. Permission Model (RBAC)

Six roles with permission mappings across domains.

```mermaid
flowchart TB
    subgraph Roles["User Roles"]
        OWNER["OWNER<br/>Full access + billing"]
        ADMIN["ADMIN<br/>All features, no billing"]
        ACCOUNTANT["ACCOUNTANT<br/>Financial operations"]
        BOOKKEEPER["BOOKKEEPER<br/>Data entry"]
        INVESTOR["INVESTOR<br/>Read-only reports"]
        ADVISOR["ADVISOR<br/>External consultant"]
    end

    subgraph Domains["Permission Domains"]
        D1["Overview<br/>(Dashboard)"]
        D2["Money Movement<br/>(Invoices, Bills, Banking)"]
        D3["Business<br/>(Clients, Vendors, Products)"]
        D4["Accounting<br/>(GL, Reports, Journal)"]
        D5["Planning<br/>(Budget, Forecast)"]
        D6["AI Advisor<br/>(Insights, Chat)"]
        D7["Services<br/>(Apps, Integrations)"]
        D8["System<br/>(Settings, Users, Billing)"]
    end

    subgraph Permissions["Permission Types"]
        VIEW["VIEW<br/>Read data"]
        CREATE["CREATE<br/>Add records"]
        EDIT["EDIT<br/>Modify records"]
        DELETE["DELETE<br/>Remove records"]
        APPROVE["APPROVE<br/>Authorize actions"]
        ADMIN_P["ADMIN<br/>Configure system"]
    end

    %% OWNER - Full access
    OWNER --> |all| D1 & D2 & D3 & D4 & D5 & D6 & D7 & D8

    %% ADMIN - All except billing
    ADMIN --> |all| D1 & D2 & D3 & D4 & D5 & D6 & D7
    ADMIN -.-> |limited| D8

    %% ACCOUNTANT - Financial focus
    ACCOUNTANT --> |full| D1 & D2 & D4
    ACCOUNTANT --> |view| D3 & D5 & D6
    ACCOUNTANT -.-> |none| D7 & D8

    %% BOOKKEEPER - Data entry
    BOOKKEEPER --> |view/create| D1 & D2 & D3
    BOOKKEEPER --> |view| D4
    BOOKKEEPER -.-> |none| D5 & D6 & D7 & D8

    %% INVESTOR - Read-only
    INVESTOR --> |view| D1 & D4 & D5
    INVESTOR -.-> |none| D2 & D3 & D6 & D7 & D8

    %% ADVISOR - Consulting access
    ADVISOR --> |view| D1 & D4 & D5 & D6
    ADVISOR -.-> |none| D2 & D3 & D7 & D8

    classDef owner fill:#9C27B0,stroke:#333,color:#fff
    classDef admin fill:#2196F3,stroke:#333,color:#fff
    classDef accountant fill:#4CAF50,stroke:#333,color:#fff
    classDef bookkeeper fill:#FF9800,stroke:#333,color:#fff
    classDef readonly fill:#607D8B,stroke:#333,color:#fff

    class OWNER owner
    class ADMIN admin
    class ACCOUNTANT accountant
    class BOOKKEEPER bookkeeper
    class INVESTOR,ADVISOR readonly
```

**Permission Matrix Summary:**

| Domain | OWNER | ADMIN | ACCOUNTANT | BOOKKEEPER | INVESTOR | ADVISOR |
|--------|-------|-------|------------|------------|----------|---------|
| Overview | Full | Full | Full | View | View | View |
| Money Movement | Full | Full | Full | Create | - | - |
| Business | Full | Full | View | Create | - | - |
| Accounting | Full | Full | Full | View | View | View |
| Planning | Full | Full | View | - | View | View |
| AI Advisor | Full | Full | View | - | - | View |
| Services | Full | Full | - | - | - | - |
| System | Full | Limited | - | - | - | - |

**Role Descriptions:**
- **OWNER**: Business owner with full control including billing
- **ADMIN**: Office manager, all features except billing/ownership
- **ACCOUNTANT**: CPA/financial professional, full accounting access
- **BOOKKEEPER**: Data entry staff, create transactions only
- **INVESTOR**: Stakeholder with read-only financial access
- **ADVISOR**: External consultant with limited read access

---

## Quick Reference

### Key Invariants

1. **Multi-Tenancy**: Every query MUST filter by `tenantId`
2. **Money Precision**: All amounts stored as integer cents
3. **Double-Entry**: `SUM(debits) === SUM(credits)` always
4. **Soft Delete**: Never hard delete, use `deletedAt`
5. **Source Preservation**: Store original documents in `sourceDocument`

### Service Dependencies

```mermaid
flowchart LR
    Invoice --> Journal
    Bill --> Journal
    Payment --> Journal
    Transaction --> Journal

    Journal --> GLAccount

    Invoice --> Client
    Bill --> Vendor

    Entity --> GLAccount
    Entity --> BankAccount

    BankAccount --> Transaction
```

### Data Flow Principles

1. **Write Path**: UI → Validation → Service → Prisma → PostgreSQL → Journal
2. **Read Path**: UI ← Transform ← Service ← Prisma ← PostgreSQL
3. **Event Flow**: Action → Domain Event → Event Handler → Side Effects

---

**See Also:**
- `docs/domain-glossary.md` - Term definitions and invariants
- `docs/repo-map.md` - Code location guide
- `docs/standards/` - Implementation standards
