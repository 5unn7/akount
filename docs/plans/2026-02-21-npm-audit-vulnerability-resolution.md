# NPM Audit Vulnerability Resolution

**Created:** 2026-02-21
**Status:** Draft
**Priority:** High
**Estimated Effort:** 3-4 hours

## Overview

Resolve all 15 npm security vulnerabilities (2 moderate, 13 high) identified in `npm audit`. This includes safe upgrades of dev dependencies and migration from the vulnerable `xlsx` package to the actively maintained `exceljs` library for production Excel file handling.

## Current Vulnerabilities

### Dev Dependencies (Safe to Upgrade)
1. **markdown-it** (moderate) - ReDoS vulnerability
   - Used by: `markdownlint-cli2@0.20.0` (markdown linting)
   - Fix: Upgrade to `markdownlint-cli2@0.21.0+`

2. **minimatch** (high) - ReDoS via repeated wildcards
   - Used by: `eslint@8.57.1`, `archiver@7.0.1`, and transitive dependencies
   - Fix: Upgrade eslint to v10 (breaking changes, dev-only)

### Production Dependencies (Requires Code Changes)
3. **xlsx@0.18.5** (high) - Prototype Pollution + ReDoS
   - Used in: `apps/api/src/domains/banking/services/parser-csv.ts` (XLSX import parsing)
   - Impact: Production code - bank statement import feature
   - Fix: Migrate to `exceljs@4.4.0` (actively maintained, secure)

## Migration Strategy

**ExcelJS** is the recommended replacement because:
- Actively maintained (weekly updates vs xlsx's stale releases)
- Better security posture (no known CVEs)
- Streaming support for large files (better performance)
- Full read/write support with formatting
- Compatible API for basic operations

**Sources:**
- [Exceljs(Alternate for XLSX package) | by Manisha Siram | Medium](https://medium.com/@manishasiram/exceljs-alternate-for-xlsx-package-fc1d36b2e743)
- [xlsx vs exceljs vs excel4node vs xlsx-populate | Excel File Manipulation in Node.js](https://npm-compare.com/excel4node,exceljs,xlsx,xlsx-populate)
- [NPM + SheetJS XLSX in 2026: Safe Installation, Secure Parsing, and Real-World Node.js Patterns – TheLinuxCode](https://thelinuxcode.com/npm-sheetjs-xlsx-in-2026-safe-installation-secure-parsing-and-real-world-nodejs-patterns/)

## Success Criteria

- [ ] All 15 npm audit vulnerabilities resolved
- [ ] Zero new vulnerabilities introduced
- [ ] XLSX import functionality works identically (backward compatible)
- [ ] All existing tests pass (1133 backend tests)
- [ ] No breaking changes to API contracts
- [ ] File scanner still detects XLSX magic bytes correctly

---

## Tasks

### Sprint 1: Dev Dependencies Upgrade (Low Risk)

#### Task 1.1: Upgrade markdownlint-cli2
**File:** `package.json`
**What:** Upgrade `markdownlint-cli2` from `^0.20.0` to `^0.21.0+` to fix markdown-it ReDoS vulnerability
**Depends on:** none
**Success:** `npm audit` shows markdown-it vulnerability resolved, `npm run lint:md` works

#### Task 1.2: Upgrade eslint to v10
**File:** `apps/api/package.json`, `packages/db/package.json`
**What:** Upgrade `eslint` from `^8.57.1` to `^10.0.0+` to fix minimatch vulnerability
**Depends on:** Task 1.1
**Risk:** medium (breaking changes in eslint v9-v10, but dev-only)
**Success:** `npm audit` shows minimatch vulnerability count reduced, `npm run lint` works in all workspaces

#### Task 1.3: Verify dev dependency fixes
**File:** none (verification only)
**What:** Run `npm audit` and verify markdown-it + minimatch vulnerabilities are resolved (should go from 15 → 3)
**Depends on:** Task 1.2
**Success:** Only xlsx vulnerabilities remain (3 high), all dev dependency warnings cleared

---

### Sprint 2: ExcelJS Migration (Production Code)

#### Task 2.1: Install exceljs and update dependencies
**File:** `apps/api/package.json`
**What:** Add `exceljs@^4.4.0`, remove `xlsx@^0.18.5` from dependencies
**Depends on:** Task 1.3 (to isolate changes)
**Success:** `npm install` succeeds, no conflicts

#### Task 2.2: Migrate parseXLSX function to exceljs
**File:** `apps/api/src/domains/banking/services/parser-csv.ts`
**What:** Replace `XLSX.read()` and `XLSX.utils.sheet_to_json()` with ExcelJS API
**Depends on:** Task 2.1
**Risk:** high (production code, financial data parsing)
**Review:** `security-sentinel`, `fastify-api-reviewer`
**Success:** Function signature unchanged, returns same ParseResult structure

**Implementation Notes:**
```typescript
// OLD (xlsx):
const workbook = XLSX.read(fileBuffer, { type: 'buffer' });
const sheet = workbook.Sheets[workbook.SheetNames[0]];
const rows = XLSX.utils.sheet_to_json<Record<string, string>>(sheet, {
  raw: false,
  defval: '',
});

// NEW (exceljs):
const workbook = new ExcelJS.Workbook();
await workbook.xlsx.load(fileBuffer);
const worksheet = workbook.worksheets[0];
const rows = worksheet.getRows(1, worksheet.rowCount) || [];
// Convert rows to Record<string, string> format (match xlsx output)
```

#### Task 2.3: Update file scanner XLSX magic bytes check
**File:** `apps/api/src/lib/file-scanner.ts`
**What:** Verify XLSX magic bytes detection still works (no code change needed, but validate)
**Depends on:** Task 2.2
**Success:** XLSX files with ZIP header (0x504B0304) correctly identified, macro detection works

#### Task 2.4: Update parseXLSX tests
**File:** `apps/api/src/domains/banking/services/__tests__/parser-csv.test.ts` (if exists)
**What:** Update test mocks/assertions for exceljs API (async load vs sync read)
**Depends on:** Task 2.2
**Success:** All parser tests pass

#### Task 2.5: Update imports route tests
**File:** `apps/api/src/domains/banking/routes/__tests__/imports.routes.test.ts`
**What:** Verify XLSX import endpoint tests still pass with exceljs backend
**Depends on:** Task 2.4
**Success:** 5 XLSX import tests pass (lines 411, 439, 463, 491, 522 from grep)

#### Task 2.6: Update file scanner tests
**File:** `apps/api/src/lib/__tests__/file-scanner.test.ts`
**What:** Ensure XLSX magic bytes tests still pass (lines 46, 126 from grep)
**Depends on:** Task 2.5
**Success:** Magic bytes validation and macro detection tests pass

---

### Sprint 3: Final Verification

#### Task 3.1: Run full test suite
**File:** none (verification only)
**What:** Execute `cd apps/api && npm run test` to verify all 1133+ tests pass
**Depends on:** Task 2.6
**Success:** All tests pass, no new failures introduced

#### Task 3.2: Type check
**File:** none (verification only)
**What:** Run `npm run typecheck` to ensure no TypeScript errors
**Depends on:** Task 3.1
**Success:** Zero TypeScript errors (maintain current 0 TS errors)

#### Task 3.3: Final npm audit
**File:** none (verification only)
**What:** Run `npm audit` and verify all 15 vulnerabilities resolved
**Depends on:** Task 3.2
**Success:** `npm audit` shows 0 vulnerabilities (or only low-severity unrelated issues)

#### Task 3.4: Update MEMORY.md Known Issues
**File:** `C:\Users\Sunny\.claude\projects\w--Marakana-Corp-Companies-akount-Development-Brand-aggoogle-product-plan\memory\MEMORY.md`
**What:** Remove "NPM vulnerabilities (16, 13 high)" from Known Issues table
**Depends on:** Task 3.3
**Success:** Known Issues table updated, no npm audit entry

---

## Reference Files

- `apps/api/package.json` — Production dependencies
- `package.json` — Root dev dependencies
- `apps/api/src/domains/banking/services/parser-csv.ts` — XLSX usage (parseXLSX function)
- `apps/api/src/lib/file-scanner.ts` — XLSX magic bytes validation
- `apps/api/src/domains/banking/routes/imports.ts` — Import endpoint (calls parseXLSX)
- ExcelJS docs: https://github.com/exceljs/exceljs#reading-xlsx

## Edge Cases

- **Large XLSX files:** ExcelJS supports streaming - if files >10MB become common, add streaming mode
- **Excel 97-2003 (.xls) format:** ExcelJS doesn't support binary XLS - file scanner already rejects these (OLE2 magic bytes not in XLSX signature)
- **Password-protected files:** Both libraries reject encrypted files - no change needed
- **Formulas:** Current implementation uses `raw: false` to get calculated values - ExcelJS equivalent is default behavior
- **Empty sheets:** Both libraries throw on empty sheets - existing error handling covers this

## Review Agent Coverage

| Task | Relevant Agents |
|------|----------------|
| Task 2.2 | `security-sentinel` (file parsing), `fastify-api-reviewer` (service pattern) |
| Task 2.4-2.6 | `kieran-typescript-reviewer` (test updates) |

## Domain Impact

- **Primary domains:** Banking (import service)
- **Adjacent domains:** None (isolated to import feature)
- **API contract changes:** None (internal implementation only)

## Testing Strategy

1. **Unit tests:** All parser and file scanner tests must pass
2. **Integration tests:** XLSX import route tests must pass (5 tests in imports.routes.test.ts)
3. **Manual verification:** Upload sample XLSX bank statement via import endpoint
4. **Regression check:** Run full 1133-test suite to ensure no side effects

## Rollback Plan

If ExcelJS migration fails:
1. Revert `package.json` changes: `git checkout HEAD -- apps/api/package.json`
2. Revert code changes: `git checkout HEAD -- apps/api/src/domains/banking/services/parser-csv.ts`
3. Run `npm install` to restore xlsx
4. Accept xlsx vulnerability temporarily, document risk in TASKS.md

## Progress

- [ ] Sprint 1: Dev Dependencies (Tasks 1.1-1.3)
- [ ] Sprint 2: ExcelJS Migration (Tasks 2.1-2.6)
- [ ] Sprint 3: Final Verification (Tasks 3.1-3.4)

---

**Total Tasks:** 13
**Estimated Time:** 3-4 hours (1h dev deps + 2h migration + 1h testing)
**Risk Level:** Medium (production code change, but isolated to one function)
