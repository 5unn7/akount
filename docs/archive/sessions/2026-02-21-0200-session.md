# Session Summary — 2026-02-21 02:00

## What Was Done
- Diagnosed and fixed Prisma shadow database failure (`P3006` error)
- **Root cause:** 3 migrations from 2026-02-20 had incorrect timestamp ordering — index migrations referencing `deletedAt` columns ran before the migration that added those columns
- Squashed 3 conflicting migrations into 1 combined migration with correct order (columns first, then indexes)
- Created baseline drift migration to capture all `db push` changes not recorded in migration files (~30 schema changes: onboarding, entity fields, user fields, category tenant scoping, audit log integrity fields, performance indexes)
- Fixed 2 bugs in baseline migration: duplicate `CreditNote_entityId_deletedAt_idx` index + `Category.tenantId` nullability/FK action mismatch
- Updated `_prisma_migrations` table on live DB to reconcile all changes
- Verified `prisma migrate dev` runs cleanly (shadow database replays all 8 migrations successfully)

## Files Changed
- `packages/db/prisma/migrations/20260220164700_add_deleted_at_and_perf_indexes/migration.sql` (NEW — combined migration replacing 3 old ones)
- `packages/db/prisma/migrations/20260221004000_baseline_drift/migration.sql` (NEW — captures all db push drift)
- Deleted: `20260220164700_add_perf_21_22_indexes/`, `20260220170000_add_deleted_at_columns/`, `20260220170100_add_perf_18_19_20_indexes/`

## Commits Made
- None yet (migration fix is uncommitted — needs commit)

## Bugs Fixed / Issues Hit
1. **Shadow database P3006 error** — Root cause: migration `20260220164700_add_perf_21_22_indexes` created indexes on `deletedAt` columns that didn't exist yet (added by later migration `20260220170000`). Fix: squashed 3 migrations into 1 with correct order.
2. **Schema drift** — Dozens of schema changes applied via `db push` weren't in migration files. Fix: baseline migration captures all drift.
3. **Duplicate index in baseline** — `CreditNote_entityId_deletedAt_idx` was created by both the combined migration and the baseline. Fix: removed from baseline, kept DROP of old index.
4. **Category.tenantId nullability** — Baseline had `TEXT` (nullable) + `ON DELETE SET NULL`, but schema requires `TEXT NOT NULL` + `ON DELETE RESTRICT`. Fix: corrected both.

## Patterns Discovered
- **Migration ordering is critical** — When creating multiple migrations on the same day, verify that DDL dependencies (columns before indexes) are respected by timestamp ordering
- **`db push` creates invisible drift** — Schema changes via `db push` work fine day-to-day but accumulate drift that breaks `migrate dev` (shadow database can't reproduce the state). Baseline migrations reconcile this.
- **`prisma migrate resolve --applied`** — Use this to mark migrations as applied without running them (for baseline/squash workflows). Re-resolve after editing migration files to update checksums.

## Unfinished Work
- Migration files need to be committed (currently uncommitted changes in `packages/db/prisma/migrations/`)
- The deleted old migration directories may show as untracked deletes in git

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Checked task availability (Step 0) before implementation — this was a diagnose workflow
- [x] Read existing files before editing (read all 3 migration files before changes)
- [x] Searched for patterns via Grep (searched for shadow database in memory, checked index conflicts)
- [x] Used offset/limit for large files (>300 lines) — used for schema.prisma
- [x] Verified patterns with Grep (confirmed duplicate index before removing)
- [x] Searched MEMORY topic files before implementing

### Did I Violate Any Invariants?
- N/A — this was a migration fix, no application code changed

### Loops or Repeated Mistakes Detected?
- Took 3 iterations to get baseline migration right (initial → fix duplicate index → fix Category nullability)
- Could have been avoided by more carefully comparing the drift output against existing migrations BEFORE writing the baseline

### What Would I Do Differently Next Time?
- Before writing a baseline migration, systematically cross-reference EVERY index/column against ALL existing migration files to prevent duplicates
- Check column nullability in schema before writing ALTER TABLE statements (don't assume nullable)
- Check FK actions (ON DELETE behavior) in Prisma schema — Prisma default is RESTRICT, not SET NULL

### Context Efficiency Score (Self-Grade)
- **File reads:** Efficient — used offset/limit on schema.prisma, delegated full read to Explore agent
- **Pattern verification:** Mostly verified — missed the Category nullability on first pass
- **Memory usage:** Checked topic files first (no prior shadow DB issues found)
- **Overall grade:** B (good — fixed the issue but took 3 iterations on baseline)

## Artifact Update Hints
- `MEMORY.md debugging-log.md` — Add shadow database fix pattern (migration ordering, baseline drift)
- Migration files need to be committed
