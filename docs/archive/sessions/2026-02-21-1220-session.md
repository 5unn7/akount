# Session Summary — 2026-02-21 12:20

## What Was Done
- Fixed all 268 TypeScript errors (263 API + 5 web) introduced by recent development sprints
- Diagnosed 6 root cause categories across 51 files
- Updated 26 test files to match corrected service signatures/behavior
- Verified 0 TS errors in both API and web apps
- Verified all 1133 tests pass (0 failures)

## Root Causes Identified

### RC1: Schema/Type Drift (most common)
Code referenced Prisma fields and enum values that don't exist:
- `Entity.deletedAt`, `Entity.notes`, `Entity.metadata` (Entity has none of these)
- `BillStatus.RECEIVED` → correct: `PENDING`
- `AuditAction.EXPORT` → correct: `VIEW`
- `Role` from `@akount/types` had 7 values (OWNER/ADMIN/ACCOUNTANT/BOOKKEEPER/INVESTOR/ADVISOR/VIEWER) but Prisma `TenantUserRole` only has 4 (OWNER/ADMIN/ACCOUNTANT/VIEWER)

### RC2: Type Strictness
- `unknown` typed errors used without `instanceof Error` guards
- `null` vs `undefined` mismatches (e.g., `string | null` not assignable to `string | undefined`)
- `Prisma.InputJsonValue` cast issues for JSON fields (before/after audit data)
- Spread on potentially non-object types (`where.issueDate`)

### RC3: Module Resolution
- Dynamic imports missing `.js` extensions required by `NodeNext` resolution
- Wrong import paths for `TenantContext` (moved to `middleware/tenant.ts`)

### RC4: Validation Middleware Misuse
- `validateParams()` called with plain objects `{ id: { type: 'string' } }` instead of Zod schemas `z.object({ id: z.string() })`

### RC5: Report Service Types
- P&L reports use `sections`, Balance Sheet/Cash Flow use `items` — code used wrong property names
- PDF template referenced wrong interfaces

### RC6: Web App Errors
- Import path aliases (`@/`) not resolving in some contexts
- Minor type mismatches in 5 web files

## Files Changed (51 files)
- 27 source files (services, routes, middleware, schemas, templates)
- 22 test files (updated assertions to match corrected behavior)
- 2 config files (package.json, package-lock.json)

## Commits Made
- None yet (all changes uncommitted — ready for commit)

## Bugs Fixed / Issues Hit
- **Entity has no `deletedAt` field**: Multiple services (client, vendor, flinks, planning) were filtering Entity queries with `deletedAt: null`. Entity model doesn't have this field — it's not soft-deletable.
- **BillStatus enum mismatch**: `RECEIVED` was used in vendor.service.ts but doesn't exist in Prisma. Correct value is `PENDING`.
- **TenantUserRole vs Role**: `@akount/types` defined 7 roles but Prisma schema only has 4. `withPermission.ts` was importing from the wrong package.
- **`error.message` on unknown**: Three catch blocks in import.service.ts accessed `.message` on `unknown` typed errors without type guards.

## Patterns Discovered

### CRITICAL: Why 268 TS Errors Accumulated (Prevention Protocol)
The errors were introduced across 5 major feature sprints (NUJ UX Overhaul, Entity Management Hub, Banking Command Center, Onboarding Flow, Dashboard Redesign) where:
1. **No `tsc --noEmit` gate was run** between sprints
2. **Prisma schema was modified** (fields removed, enums changed) but consuming code wasn't updated
3. **New services referenced non-existent fields** (likely from AI hallucination or stale context)
4. **Type package (`@akount/types`) drifted** from Prisma schema (source of truth)

### Prevention Rules (ADD TO MEMORY)
1. **Run `tsc --noEmit` after every sprint/plan completion** — catch errors before they accumulate
2. **Prisma schema is source of truth** — when schema changes, grep for all usages of changed fields/enums
3. **Never trust `@akount/types` for enum values** — always verify against Prisma schema
4. **Entity model facts**: no `deletedAt`, no `notes`, no `metadata`, has `functionalCurrency` (not `currency`)
5. **Enum quick reference**:
   - `TenantUserRole`: OWNER | ADMIN | ACCOUNTANT | VIEWER (NOT BOOKKEEPER/INVESTOR/ADVISOR)
   - `BillStatus`: DRAFT | PENDING | PAID | OVERDUE | CANCELLED | PARTIALLY_PAID (NOT RECEIVED)
   - `AuditAction`: CREATE | UPDATE | DELETE | VIEW (NOT EXPORT)
   - `InvoiceStatus`: DRAFT | SENT | PAID | OVERDUE | CANCELLED | PARTIALLY_PAID (NOT VOID)

## Unfinished Work
- Changes need to be committed (51 files modified, 0 TS errors, 1133 tests passing)

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Read existing files before editing (never edited blindly)
- [x] Searched for patterns via Grep before creating new code
- [x] Used offset/limit for large files (>300 lines)
- [x] Verified patterns with Grep (didn't claim patterns without proof)

### Did I Violate Any Invariants?
- [x] All queries included tenantId filter
- [x] All money fields used integer cents (no floats)
- [x] Used request.log/server.log (no console.log in production)
- [x] No `: any` types (used specific types or unknown)

### Loops or Repeated Mistakes Detected?
- Background agent modified files concurrently, causing Edit failures ("file modified since read"). Re-reading before editing resolved this.
- Some edit attempts failed because only partial file reads (with offset) were done — Edit requires a full read first.

### Context Efficiency Score
- **File reads:** Mixed (some efficient with offset/limit, some needed full reads for Edit tool)
- **Pattern verification:** Always verified via Grep
- **Memory usage:** Checked topic files
- **Overall grade:** B (good — parallel agents were very efficient but caused some concurrent modification issues)

## Artifact Update Hints
- MEMORY.md `debugging-log.md` — add prevention rules for TS error accumulation
- MEMORY.md `codebase-quirks.md` — add Entity model facts, enum quick reference
- STATUS.md — TS errors back to 0, tests still at 1133
