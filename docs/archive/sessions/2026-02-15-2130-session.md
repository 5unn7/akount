# Session Summary — 2026-02-15 21:30

## What Was Done
- Diagnosed 3 bugs reported after uploading 10 PDF bank statements: duplicate entries, no income/expense classification, no reflection in overview dashboard
- Fixed duplicate detection: absolute value comparison for amount matching + wired up internal dedup (within-file duplicates)
- Fixed PDF parser: extract balance from ALL line patterns (not just chequing format), made running-balance sign detection format-agnostic
- Fixed overview performance service: uncategorized transactions now classified by amount sign (positive=revenue, negative=expense)
- Updated tests to match new behavior (212/212 banking+overview tests passing)

## Files Changed
- `apps/api/src/domains/banking/services/duplication.service.ts` — abs() amount comparison, soft delete filter
- `apps/api/src/domains/banking/services/import.service.ts` — wired up findInternalDuplicates in CSV/XLSX/PDF paths
- `apps/api/src/domains/banking/services/parser.service.ts` — extract balance from all patterns, format-agnostic sign detection
- `apps/api/src/domains/overview/services/performance.service.ts` — amount-sign fallback for uncategorized transactions
- `apps/api/src/domains/banking/services/__tests__/import.service.test.ts` — added findInternalDuplicates mock
- `apps/api/src/domains/overview/services/__tests__/performance.service.test.ts` — updated test for new classification behavior

## Commits Made
- `bc16dde` fix(banking): PDF import dedup, balance-based sign detection, overview metrics

## Bugs Fixed / Issues Hit
- **Bug 1 — Duplicate entries after import:** Dedup service compared raw parsed amounts vs DB-stored amounts, which have different signs for credit cards (parser gives +2599, DB stores -2599). Fix: compare `Math.abs()` of both. Also, `findInternalDuplicates` existed but was never called from the import service.
- **Bug 2 — Everything shows as income:** PDF parser only determined withdrawal/deposit signs for two narrow cases (credit card type flip and DD Mon chequing format with opening balance). Other formats (Mon DD, statements with balance columns) got all-positive amounts. Fix: extract balance from ALL line patterns and make the running-balance algorithm format-agnostic — works whenever any transaction has balance data.
- **Bug 3 — No overview reflection:** Performance service required category assignments to classify as revenue/expense. Most imported transactions are uncategorized. Fix: fall back to amount sign (positive=revenue, negative=expense) when no category assigned.

## Patterns Discovered
- PDF text extraction (pdfjs-dist) groups text by Y position into lines but column positions within a line are lost — amounts appear as sequential numbers. Using `matchAll` to find ALL amounts on a line, with last amount being the running balance, is more robust than finding just the first match.
- The running-balance sign detection algorithm (brute-force 2^n for small groups) works format-agnostically — no need to gate it behind `isChequingFormat`. As long as balance data exists, it applies.

## Unfinished Work
- Pre-existing test failures in vendor.service.test.ts and client.service.test.ts (tenant isolation in bill/invoice count) — unrelated to this session's changes
- Pre-existing route test failures in clients/vendors/invoicing routes — likely from prior uncommitted route changes in git working tree

## Artifact Update Hints
- MEMORY `debugging-log.md` — add PDF dedup abs() fix and format-agnostic balance detection
- MEMORY Known Issues table — "PDF import: more bugs remain" can be updated to reflect these fixes
