# Session Summary — 2026-02-28 13:51

## What Was Done
- Diagnosed and fixed 8 TypeScript errors in `document-extraction.service.ts`
- Root cause: Zod `.default()` modifier creates input/output type split that breaks `z.ZodType<T>` generic inference in `MistralProvider.extractFromImage<T>`
- Fixed 3 schema files: removed `.default()` from `quantity` (bill + invoice) and `modelVersion` (bank statement), changed to `.optional()`
- Replaced 2 inline prompt strings in `extractInvoice` and `extractStatement` with shared prompt builders (`buildInvoiceExtractionPrompt`, `buildStatementExtractionPrompt`) — completing the P1-21 extraction that was only half-wired
- Removed unused `createSecureSystemPrompt` import from document-extraction.service.ts
- Updated 2 schema test files to match new optional quantity behavior

## Files Changed
- `apps/api/src/domains/ai/schemas/bill-extraction.schema.ts` — `quantity: .default(1)` -> `.optional()`
- `apps/api/src/domains/ai/schemas/invoice-extraction.schema.ts` — `quantity: .default(1)` -> `.optional()`
- `apps/api/src/domains/ai/schemas/bank-statement-extraction.schema.ts` — `modelVersion: .default(...)` -> `.optional()`
- `apps/api/src/domains/ai/services/document-extraction.service.ts` — use shared prompt builders, remove unused import
- `apps/api/src/domains/ai/schemas/__tests__/bill-extraction.schema.test.ts` — update default test
- `apps/api/src/domains/ai/schemas/__tests__/invoice-extraction.schema.test.ts` — update default test

## Commits Made
- None yet (changes uncommitted, ready for commit)

## Bugs Fixed / Issues Hit
- **Zod `.default()` + generics type mismatch** — `z.ZodType<T>` resolves `T` to Zod *input* type (where defaulted fields are optional), not output type (where defaults are applied). This causes TypeScript to see `quantity?: number | undefined` instead of `quantity: number`. Fix: use `.optional()` instead of `.default()` and handle defaults in business logic.
- **Incomplete P1-21 extraction** — `buildInvoiceExtractionPrompt` and `buildStatementExtractionPrompt` were extracted to `extraction-prompts.ts` but never wired up. `extractInvoice` and `extractStatement` still had inline prompts while `extractBill` correctly used the builder.

## Patterns Discovered
- **Zod `.default()` is dangerous with generics** — Never use `.default()` on Zod fields when the schema is passed to generic functions like `z.ZodType<T>`. Use `.optional()` instead and handle defaults in service code. The input/output type split breaks TypeScript inference.

## Unfinished Work
- None. All 8 TS errors resolved, schema tests updated and passing (32/32).
- Pre-existing TS errors remain (unrelated): `@ts-expect-error` directives, analyzer types, jobs route types.

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Checked task availability — ad-hoc bug fix, user asked directly
- [x] Read existing files before editing — read all 10+ imported files to trace root cause
- [x] Searched for patterns via Grep — checked all consumers of changed types
- [x] Used offset/limit for large files — used for test file reads
- [x] Verified patterns with Grep — confirmed `quantity` usage in workers
- [x] Searched MEMORY topic files — checked debugging-log.md context

### Did I Violate Any Invariants?
- [x] All queries included tenantId filter N/A (no query changes)
- [x] All money fields used integer cents N/A (schema-only changes)
- [x] Used design tokens N/A (no UI changes)
- [x] No `: any` types
- [x] No `console.log` in production

### Loops or Repeated Mistakes Detected?
- None. Systematic trace from error messages -> imports -> schemas -> root cause.

### Context Efficiency Score (Self-Grade)
- **File reads:** Efficient — read imports systematically, used `tsc --noEmit` to get exact errors
- **Pattern verification:** Always verified — Grep'd for all `quantity` usages before changing
- **Overall grade:** A

## Artifact Update Hints
- MEMORY `debugging-log.md` — add Zod `.default()` + generics gotcha
