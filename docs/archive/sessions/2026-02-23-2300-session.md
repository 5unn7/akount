# Session Summary — 2026-02-23 23:00

## What Was Done
- Diagnosed entity selector "super controller" bug across all domains using 4 parallel investigation agents
- Found 4 distinct bugs causing entity selection to be ignored in stats and transactions
- Fixed `getInvoiceStats()` — added entityId parameter, applied to all 7 Prisma aggregates
- Fixed `getBillStats()` in invoicing domain — same pattern as invoice stats
- Fixed invoice/bill stats route handlers — added Zod query schema for entityId, pass to service
- Fixed `dashboard.service.ts` and `performance.service.ts` — pass entityId to getInvoiceStats
- Fixed `listTransactions()` frontend API client — entityId was silently dropped (accepted in TS type, never appended to URL)
- Fixed transactions page — added entity cookie reading, passes entityId to all API calls
- Fixed invoices page — passes entityId to getInvoiceStats/getBillStats
- Fixed frontend API clients (invoices.ts, bills.ts) — getInvoiceStats/getBillStats now accept entityId
- Fixed 2 test assertions to account for new entityId parameter
- All 1306 tests passing, 0 TS errors

## Files Changed
- `apps/api/src/domains/invoicing/services/invoice.service.ts` (committed in 852685b)
- `apps/api/src/domains/invoicing/services/bill.service.ts` (committed in 852685b)
- `apps/api/src/domains/invoicing/routes/invoices.ts` (committed in 852685b)
- `apps/api/src/domains/invoicing/routes/bills.ts` (committed in 852685b)
- `apps/api/src/domains/overview/services/dashboard.service.ts` (committed in 852685b)
- `apps/api/src/domains/overview/services/performance.service.ts` (committed in 852685b)
- `apps/api/src/domains/invoicing/routes/__tests__/invoices.routes.test.ts` (uncommitted)
- `apps/api/src/domains/invoicing/routes/__tests__/bills.routes.test.ts` (uncommitted)
- `apps/web/src/lib/api/transactions.ts` (uncommitted)
- `apps/web/src/lib/api/invoices.ts` (uncommitted)
- `apps/web/src/lib/api/bills.ts` (uncommitted)
- `apps/web/src/app/(dashboard)/banking/transactions/page.tsx` (uncommitted)
- `apps/web/src/app/(dashboard)/business/invoices/page.tsx` (uncommitted)

## Commits Made
- 852685b feat(api): add entityId filter to invoice/bill stats endpoints (backend only)
- 0fbf7cc feat(dashboard): polish widgets — scrollbar, entities redesign, height fixes (prior session)

## Bugs Fixed / Issues Hit
- **Root cause: Stats functions tenant-scoped, not entity-scoped** — `getInvoiceStats()` and `getBillStats()` only filtered by `tenantId`, ignoring entity selection entirely. Dashboard numbers showed all-entity totals regardless of selection.
- **Silent parameter drop in listTransactions** — TypeScript type accepted `entityId` but the function never appended it to the URL query string. No compile error, no runtime error, just silently ignored.
- **Transactions page missing entity cookie reading** — Unlike accounts page (correct reference), transactions page never read the entity selection cookie. All transactions showed regardless of entity.
- **Stats route handlers missing query param** — Even after services accepted entityId, route handlers didn't extract it from the query string and pass it through.

## Patterns Discovered
- **Silent parameter drop is a dangerous pattern** — When a TypeScript type accepts a field but the implementation ignores it, there's no compile-time or runtime error. Need to verify API client functions actually USE all params they accept.
- **Stats vs List asymmetry** — List operations are often correctly entity-filtered while aggregate/stats functions are not, because stats were added later as a separate concern.
- **entityFilter object pattern** — Clean way to conditionally add entity filtering: `const entityFilter = { tenantId: ctx.tenantId, ...(entityId && { id: entityId }) }`

## Unfinished Work
- **7 uncommitted files** need to be committed: frontend API clients (3), pages (2), test fixes (2)
- Backend changes already committed in 852685b

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Checked task availability (Step 0) before implementation
- [x] Read existing files before editing (never edited blindly)
- [x] Searched for patterns via Grep before creating new code
- [x] Used offset/limit for large files (>300 lines)
- [x] Verified patterns with Grep (didn't claim patterns without proof)
- [x] Searched MEMORY topic files before implementing

### Did I Violate Any Invariants?
- [x] All queries included tenantId filter
- [x] All money fields used integer cents (no floats)
- [x] All financial records soft-deleted (no hard deletes)
- [x] All page.tsx files have loading.tsx + error.tsx
- [x] No mixing server imports with 'use client'
- [x] Used design tokens (no hardcoded colors)
- [x] Used request.log/server.log (no console.log in production)
- [x] No `: any` types (used specific types or unknown)

### Loops or Repeated Mistakes Detected?
- Minor: "File has been unexpectedly modified" error on first edit attempt of invoice.service.ts due to concurrent modification. Recovered by re-reading.
- Some parallel edit attempts failed with "file has not been read" errors — had to serialize reads then edits.

### What Would I Do Differently Next Time?
- When editing files that might be touched by linters or other processes, serialize read+edit pairs rather than parallel reads then parallel edits.

### Context Efficiency Score (Self-Grade)
- **File reads:** Efficient — used offset/limit for test files, parallel reads for investigation
- **Pattern verification:** Always verified — used 4 parallel agents for comprehensive diagnosis
- **Memory usage:** Checked topic files via agents
- **Overall grade:** A (efficient parallel investigation, clean implementation)

## Artifact Update Hints
- MEMORY.md: Add "silent parameter drop" pattern to Key Patterns Learned
- MEMORY.md: Update test count to 1306
- debugging-log.md: Add entity selector diagnosis for future reference
