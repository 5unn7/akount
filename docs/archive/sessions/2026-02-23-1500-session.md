# Session Summary — 2026-02-23 15:00

## What Was Done
- Fixed Next.js 16 build error: `ssr: false` not allowed in Server Components
- Applied two-tier solution:
  - **Landing page (/)**: Created Client Component wrapper with mounted state check for 3D WebGL component
  - **Report pages**: Removed unnecessary `dynamic()` imports (components already had `'use client'`)
- Discovered and documented the distinction between components that legitimately need `ssr: false` (WebGL, Canvas) vs regular Client Components that don't

## Files Changed
### Modified
- `apps/web/src/app/page.tsx` — Added `export const dynamic = 'force-dynamic'`
- `apps/web/src/app/(dashboard)/accounting/reports/balance-sheet/page.tsx` — Removed dynamic import, use normal import
- `apps/web/src/app/(dashboard)/accounting/reports/profit-loss/page.tsx` — Removed dynamic import, use normal import
- `apps/web/src/app/(dashboard)/accounting/reports/spending/page.tsx` — Removed dynamic import, use normal import

### Created
- `apps/web/src/components/landing/FeaturesShowcaseWrapper.tsx` — Client Component wrapper with mounted state check

## Commits Made
None (all work uncommitted, awaiting user review)

## Bugs Fixed / Issues Hit

### Bug 1: Build Error - `ssr: false` in Server Components
**Symptom:** Build failed with "ssr: false is not allowed with next/dynamic in Server Components"
**Root Cause:** Next.js 16 enforces stricter Server/Client Component boundaries. `ssr: false` can only be used in Client Components.
**Fix Applied:**
- Landing page: Created `FeaturesShowcaseWrapper.tsx` as Client Component with dynamic import + `ssr: false`
- Report pages: Removed `dynamic()` entirely (components already Client Components, didn't need `ssr: false`)

### Bug 2: Runtime Error - React Internals Access During SSR
**Symptom:** Dev mode runtime error "Cannot read properties of undefined (reading 'ReactCurrentOwner')"
**Root Cause:** Even with `ssr: false`, Next.js 16 Turbopack evaluates modules during SSR, causing `@react-three/fiber` to fail accessing React internals
**Fix Applied:** Added mounted state check using `useEffect` in wrapper component to defer rendering until client-side

## Patterns Discovered

### Next.js 16 SSR Behavior with `ssr: false`
- **Discovery:** `ssr: false` alone is insufficient for browser-only libraries in Next.js 16 with Turbopack
- **Pattern:** Use mounted state check to completely skip rendering until client-side:
  ```typescript
  const [mounted, setMounted] = useState(false);
  useEffect(() => setMounted(true), []);
  if (!mounted) return <LoadingState />;
  ```
- **When to use:** Only for libraries that require browser APIs (WebGL, Canvas, window)
- **When NOT to use:** Regular Client Components with hooks (just import normally)

### Client Component Import Simplification
- **Discovery:** Report view components already had `'use client'` directive, didn't need `dynamic()` or `ssr: false`
- **Pattern:** Not all Client Components need dynamic imports. Use dynamic imports only for:
  1. Code-splitting large components
  2. Browser-only libraries (WebGL, Canvas)
- **Antipattern:** Using `dynamic(..., { ssr: false })` on components that are already Client Components with standard React hooks

## New Systems / Features Built
None (focused on fixing existing landing page build error)

## Unfinished Work
None — all fixes complete and build verified

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Checked task availability (Step 0) before implementation — Ad-hoc bug fix, user explicitly requested
- [x] Read existing files before editing — Read page.tsx, bs-report-view.tsx, FeaturesShowcase.tsx
- [x] Searched for patterns via Grep — Checked for `ssr: false` usage across codebase
- [x] Used offset/limit for large files — Files were small (<50 lines read)
- [x] Verified patterns with Grep — Confirmed report views already had `'use client'`
- [x] Searched MEMORY topic files before implementing — No prior knowledge of this error

### Did I Violate Any Invariants?
- [x] All queries included tenantId filter ✅ (N/A - frontend work only)
- [x] All money fields used integer cents ✅ (N/A - no financial logic)
- [x] All financial records soft-deleted ✅ (N/A - no DB changes)
- [x] All page.tsx files have loading.tsx + error.tsx ✅ (N/A - no new pages)
- [x] No mixing server imports with 'use client' ✅ (Followed Next.js 16 patterns)
- [x] Used design tokens ✅ (Reused existing loading states with design tokens)
- [x] Used request.log/server.log ✅ (N/A - frontend only)
- [x] No `: any` types ✅ (Used proper typing throughout)

### Loops or Repeated Mistakes Detected?
None detected. Followed `/processes:diagnose` workflow:
1. Identified symptom quickly
2. Traced root cause (Next.js 16 restriction)
3. Questioned initial approach (wrapper for all pages vs proper pattern)
4. User prompted re-evaluation ("band-aid fix?")
5. Analyzed actual component needs (3D vs regular Client Components)
6. Applied proper fix (wrapper only for 3D, normal imports for reports)

No repeated edit attempts. No ignored context.

### What Would I Do Differently Next Time?
- **More thorough initial analysis:** Could have read the report view components BEFORE creating the wrapper pattern, would have caught that they don't need `ssr: false`
- **Question patterns earlier:** User rightly questioned "band-aid fix" — should have questioned the approach myself before creating multiple wrappers

### Context Efficiency Score (Self-Grade)
- **File reads:** Efficient — used appropriate limits, read only necessary sections
- **Pattern verification:** Always verified — checked component contents, confirmed `'use client'` presence
- **Memory usage:** N/A — new error pattern not in MEMORY yet
- **Overall grade:** A- (efficient execution, could have analyzed report components earlier)

## Artifact Update Hints

### MEMORY.md → codebase-quirks.md
Add section on Next.js 16 dynamic import patterns:
```markdown
## Next.js 16: When to Use `ssr: false`

**Use ONLY for browser-only libraries:**
- WebGL (react-three/fiber, three.js)
- Canvas manipulation
- window/document APIs

**Pattern:**
1. Create Client Component wrapper with `'use client'`
2. Use `dynamic()` with `ssr: false`
3. Add mounted state check (useEffect) to defer render until client

**Don't use for:**
- Regular Client Components with hooks (useState, useRouter, etc.)
- Components using recharts (can be SSR'd)
- Components with `'use client'` directive only

**Distinction:** `'use client'` = Client Component. `ssr: false` = skip server render entirely.
```

### apps/web/CLAUDE.md
Update "Client vs Server Components" section with Next.js 16 `ssr: false` usage pattern and when NOT to use it.

### No TASKS.md updates needed
Ad-hoc bug fix, not tracked as task.
