# Session Summary — 2026-02-23 17:00

## What Was Done
- Diagnosed invoice creation form bug from user screenshot ("Subtotal mismatch: provided 1500000, calculated 1425000")
- Ran comprehensive financial calculation audit across entire codebase using financial-data-validator agent
- Fixed 4 critical calculation bugs (FIN-25, FIN-27, FIN-28) across 3 domains
- Created 5 new tasks in TASKS.md (FIN-25, FIN-26, FIN-27, FIN-28, UX-102)
- Updated all affected test data to match corrected semantics (line.amount = pre-tax)
- Verified 917 tests passing across invoicing, accounting, and banking domains

## Bugs Fixed

### BUG-1 + BUG-2 (FIN-25): Invoice & Bill Subtotal Validation
- **Root cause:** Backend subtotal formula was `SUM(line.amount - line.taxAmount)` but `line.amount` is pre-tax (`qty * unitPrice`), so it was subtracting tax from a pre-tax amount
- **Impact:** Blocked ALL invoice and bill creation when any line had tax
- **Fix:** Changed to `SUM(line.amount)` in both invoice.service.ts and bill.service.ts

### BUG-3 (FIN-27): Document-Posting Journal Entry Amounts
- **Root cause:** Same pre-tax assumption — `netAmount = line.amount - line.taxAmount` under-credited Revenue on invoices and under-debited Expense on bills
- **Impact:** Journal entries from posted invoices/bills had incorrect GL amounts
- **Fix:** Changed to `netAmount = line.amount` in document-posting.service.ts (both invoice and bill posting)

### BUG-4 (FIN-28): Transfer Base Currency Calculation
- **Root cause:** Exchange rate applied twice when calculating baseCurrencyAmount for foreign-currency side of transfers (`Math.round(toAmount * exchangeRate)` where toAmount already had exchangeRate applied)
- **Impact:** Multi-currency transfer journal entries didn't balance in base currency
- **Fix:** Conservation of value — both sides of transfer use same base currency amount, calculated once from whichever account is in entity currency

## Files Changed
- `apps/api/src/domains/invoicing/services/invoice.service.ts` — subtotal formula fix
- `apps/api/src/domains/invoicing/services/bill.service.ts` — subtotal formula fix
- `apps/api/src/domains/invoicing/services/__tests__/invoice.service.test.ts` — test data: amount = pre-tax
- `apps/api/src/domains/invoicing/services/__tests__/bill.service.test.ts` — test data: amount = pre-tax
- `apps/api/src/domains/accounting/services/document-posting.service.ts` — netAmount formula fix
- `apps/api/src/domains/accounting/__tests__/document-posting.service.test.ts` — test data: amount = pre-tax
- `apps/api/src/domains/banking/services/transfer.service.ts` — baseCurrency calculation fix
- `TASKS.md` — added FIN-25, FIN-26, FIN-27, FIN-28, UX-102

## Commits Made
- `b52c179` fix(financial): correct 4 calculation bugs across invoicing, accounting, and banking (FIN-25, FIN-27, FIN-28)

## Patterns Discovered
- **line.amount semantic mismatch was pervasive** — The frontend always sent `amount = qty * unitPrice` (pre-tax), but 4 backend locations assumed it included tax. This type of semantic drift is dangerous in financial apps — a single field meaning different things in different places
- **Conservation of value for transfers** — Both sides of a transfer must have the same base currency amount. You can't independently convert each side; they share one value expressed in entity currency
- **Test data reflects code assumptions** — When test data is wrong in the same way as the code, tests pass but the system is broken. The test mocks had `amount: 110000` (with tax included) matching the wrong formula, so tests passed while real usage failed

## Unfinished Work
- **FIN-26** (High) — Wire taxRateId to invoice/bill line items (Zod schema + service). Ready to implement.
- **UX-102** (High) — Replace manual tax input with tax rate dropdown + auto-calculation in LineItemBuilder. Depends on FIN-26.
- **SUS-2 from audit** — Float-to-cents conversion without `Math.round()` in some places. Minor but should be fixed.
- **Duplicate JE on transfers** — transfer.service.ts creates TWO identical journal entries linked via linkedEntryId. May be intentional design but looks like double-counting. Needs investigation.

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Checked task availability (Step 0) before implementation
- [x] Read existing files before editing (never edited blindly)
- [x] Searched for patterns via Grep before creating new code
- [x] Used offset/limit for large files (>300 lines)
- [x] Verified patterns with Grep (didn't claim patterns without proof)
- [x] Searched MEMORY topic files before implementing

### Did I Violate Any Invariants?
- [x] All queries included tenantId filter N/A (no new queries)
- [x] All money fields used integer cents (no floats)
- [x] All financial records soft-deleted (no hard deletes) N/A
- [x] All page.tsx files have loading.tsx + error.tsx N/A
- [x] No mixing server imports with 'use client' N/A
- [x] Used design tokens (no hardcoded colors) N/A
- [x] Used request.log/server.log (no console.log in production)
- [x] No `: any` types (used specific types or unknown)

### Loops or Repeated Mistakes Detected?
None. Session was focused and efficient — diagnostic → fix → test → commit.

### Context Efficiency Score (Self-Grade)
- **File reads:** Efficient (used offset/limit for all service files)
- **Pattern verification:** Always verified (Grep for all `line.amount - line.taxAmount` instances)
- **Memory usage:** Checked MEMORY at session start
- **Overall grade:** A

## Artifact Update Hints
- FIN-25 should be marked done in TASKS.md (commit b52c179)
- FIN-27, FIN-28 should be marked done in TASKS.md (same commit)
- MEMORY debugging-log.md should capture the "line.amount semantic mismatch" pattern
- apps/api/CLAUDE.md could note the `line.amount = pre-tax (qty * unitPrice)` convention
