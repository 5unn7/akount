# Session Summary — 2026-02-15 22:30

## What Was Done
- Fixed category engine architecture: consolidated duplicate category seeding from 2 independent paths to 1 source of truth
- Removed duplicate `DEFAULT_CATEGORIES` list (16 items) from `import.service.ts` — now delegates to `CategoryService.seedDefaults()`
- Fixed missing `deletedAt: null` filters in `categorization.service.ts` (3 queries were matching soft-deleted categories)
- Fixed `apiClient` bug: was always setting `Content-Type: application/json` even for POST requests with no body, causing Fastify to reject empty-body requests
- Removed "Clean Up Duplicates" button from transactions page (was a band-aid for the root cause bug)
- Cleaned up unused dedup server actions and imports
- Added auth/tenant middleware hooks to `categoryRoutes` (from prior session continuation)
- Fixed category route test expectation for `isActive` (string vs boolean with mocked validation)
- Added category dedup route (`POST /categories/dedup`) and transaction dedup route (`POST /transactions/dedup`)
- Created `CategorySelector` component, `CategoryService`, category schemas, category API client, and category server actions (from prior session)

## Files Changed
- `apps/api/src/domains/banking/services/import.service.ts` — Removed duplicate DEFAULT_CATEGORIES + ensureDefaultCategories(), delegates to CategoryService
- `apps/api/src/domains/ai/services/categorization.service.ts` — Added `deletedAt: null` to 3 category queries
- `apps/web/src/lib/api/client.ts` — Fixed Content-Type only set when body exists
- `apps/web/src/components/transactions/TransactionsListClient.tsx` — Removed dedup button + related state/handlers
- `apps/web/src/app/(dashboard)/banking/transactions/actions.ts` — Removed dedup server actions
- `apps/api/src/domains/banking/routes/categories.ts` — New: full CRUD + seed + dedup routes with auth/tenant hooks
- `apps/api/src/domains/banking/services/category.service.ts` — New: CRUD + seedDefaults + deduplicateCategories
- `apps/api/src/domains/banking/schemas/category.schema.ts` — New: Zod schemas for categories
- `apps/api/src/domains/banking/routes/__tests__/categories.routes.test.ts` — New: 21 tests
- `apps/web/src/components/transactions/CategorySelector.tsx` — New: inline category dropdown
- `apps/web/src/lib/api/categories.ts` — New: frontend API client for categories
- `apps/api/src/domains/banking/services/duplication.service.ts` — Added deduplicateExistingTransactions()
- `apps/api/src/domains/banking/routes/transactions.ts` — Added POST /dedup endpoint
- `apps/web/src/lib/api/transactions.ts` — Added deduplicateTransactions()

## Commits Made
- None yet (all uncommitted changes from this session + prior session continuation)

## Bugs Fixed
- **Duplicate categories root cause:** Two independent `DEFAULT_CATEGORIES` lists (16 in import.service.ts, 20 in category.service.ts) each seeded independently. Fixed by removing the duplicate from import.service.ts and delegating to CategoryService.
- **Categorization matching deleted categories:** `categorizeTransactions()` queried `where: { tenantId }` without `deletedAt: null`, matching soft-deleted duplicate categories.
- **API client empty body error:** `apiClient` always set `Content-Type: application/json`. POST requests with no body (like `/categories/dedup`) caused Fastify to reject with "Body cannot be empty when content-type is set to 'application/json'".
- **Category route tests failing (21/21):** `categoryRoutes` was missing `fastify.addHook('onRequest', authMiddleware)` and `fastify.addHook('preHandler', tenantMiddleware)`.

## Patterns Discovered
- Fastify rejects `Content-Type: application/json` when there's no request body. The API client should only set this header when `options.body` is provided.
- Category seeding should have ONE source of truth. Multiple seeding paths = guaranteed duplicates.

## Unfinished Work
- **Existing duplicate data not cleaned up:** The user's database still has duplicate categories and transactions from before the fix. The dedup API endpoint exists (`POST /categories/dedup`) but nothing triggers it automatically on page load. Next import will trigger `seedDefaults()` which runs dedup internally.
- **All changes are uncommitted** — need to commit the category engine + bug fixes.
- **Pre-existing test failures in vendors/clients/invoicing domains** (6 files, 2 test failures) — unrelated to this session's work, existed before.

## Artifact Update Hints
- `apps/api/CLAUDE.md` — New category routes/service/schema need documenting
- `MEMORY.md debugging-log.md` — apiClient Content-Type bug, duplicate seeding pattern
- `TASKS.md` — Category engine work should be tracked/checked off
