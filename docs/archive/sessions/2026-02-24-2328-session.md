# Session: 2026-02-24 23:28 — Business Payment & Document Actions

## Duration
~2 hours

## Commits
- `bc6de0c` feat(business): payment allocation UI, delete actions, Post to GL (DEV-76/77/78)
- `c444e75` feat(business): add delete buttons to client/vendor detail pages (DEV-73/74)

## Tasks Completed

### DEV-76: Payment Allocation UI
- Added inline allocation section to `PaymentForm.tsx`
- Fetches open invoices/bills when client/vendor selected
- Allocation table with per-document input + "Full" button
- Running totals (allocated, unallocated, over-allocated warning)
- Two-phase submit: create payment then allocate sequentially
- Validation: per-doc outstanding limit + total allocation limit

### DEV-77: Delete Actions (Invoices, Bills, Payments)
- Invoice delete: server action + AlertDialog in `invoice-actions.tsx` (DRAFT/CANCELLED only)
- Bill delete: server action + AlertDialog in `bill-actions.tsx` (DRAFT/CANCELLED only)
- Payment delete: browser-side `apiFetch` DELETE in `PaymentTable.tsx` PaymentDetail component

### DEV-78: Post to GL on Payment Allocations
- Added `postPaymentAllocation` API function in `payments.ts`
- Post to GL button per allocation in `PaymentDetail` component
- Bank GL account selector (fetches ASSET accounts from COA)
- Shows "View JE" link after successful posting

### DEV-73/74 Verification + Delete Buttons
- Verified DEV-71 (invoice/bill edit for DRAFT) was complete
- Verified DEV-73 (vendor CRUD) was complete except delete UI
- Verified DEV-74 (client CRUD) was complete except delete UI
- Added delete button with AlertDialog to `vendor-detail-client.tsx`
- Added delete button with AlertDialog to `client-detail-client.tsx`

## Files Changed (this session)
- `apps/web/src/lib/api/payments.ts` — Added `postPaymentAllocation`, `deletePayment`
- `apps/web/src/components/business/PaymentTable.tsx` — Post to GL + delete in PaymentDetail
- `apps/web/src/components/business/PaymentForm.tsx` — Allocation UI (fetch, table, two-phase submit)
- `apps/web/src/app/(dashboard)/business/invoices/[id]/actions.ts` — `deleteInvoiceAction`, `voidInvoiceAction`
- `apps/web/src/app/(dashboard)/business/invoices/[id]/invoice-actions.tsx` — Delete button
- `apps/web/src/app/(dashboard)/business/bills/[id]/actions.ts` — `deleteBillAction`
- `apps/web/src/app/(dashboard)/business/bills/[id]/bill-actions.tsx` — Delete button
- `apps/web/src/app/(dashboard)/business/clients/[id]/client-detail-client.tsx` — Delete button
- `apps/web/src/app/(dashboard)/business/vendors/[id]/vendor-detail-client.tsx` — Delete button
- `TASKS.md` — DEV-71/73/74/76/77/78 marked done

## Patterns Used
- **AlertDialog for destructive actions** — Consistent confirmation pattern across all delete buttons
- **apiFetch browser-side** — Client components use `@/lib/api/client-browser` for mutations
- **Two-phase submit** — Payment creation + allocation as separate API calls (sequential to avoid race conditions)
- **Optimistic state** — PaymentDetail uses `useState` for tracking posted allocations (no router.refresh)
- **Sheet key prop** — `key={vendor.id}` / `key={client.id}` for form state reset

## TypeScript Status
- 0 errors (both apps compile clean)

## Remaining Uncommitted
- `apps/api/src/domains/banking/services/duplication.service.ts` (pre-existing, not from this session)
- `apps/api/src/domains/banking/services/__tests__/duplication.service.test.ts` (pre-existing)
