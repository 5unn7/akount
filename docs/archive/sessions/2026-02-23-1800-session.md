# Session Summary — 2026-02-23 18:00

## What Was Done
- **FIN-26 (completion):** Fixed 7 remaining `billLines: true` in bill.service.ts and 6 remaining `invoiceLines: true` in invoice.service.ts to use nested includes with taxRate eager loading
- **FIN-26 (verification):** Ran all 92 bill + invoice tests — all passing
- **UX-102:** Added tax rate dropdown to LineItemBuilder with auto-calculation
  - Extended `LineItem` interface with `taxRateId`
  - Added `TaxRateOption` type and `taxRates` prop to LineItemBuilder
  - Added per-line tax rate Select dropdown with "No tax" default
  - Auto-calculates `taxAmount = Math.round(amount * rate)` when rate selected
  - Tax column becomes read-only when rate selected, stays editable when no rate
  - Grid layout adapts (7-col with rates, 6-col without)
- **UX-102 (forms):** Updated InvoiceForm and BillForm to fetch active tax rates via browser-side `apiFetch` and pass to LineItemBuilder
- **UX-102 (edit mode):** Restored `taxRateId` from existing line items when editing invoices/bills
- Verified zero TypeScript errors in apps/web

## Files Changed
- `packages/db/prisma/schema.prisma` — taxRate FK relations on InvoiceLine/BillLine
- `apps/api/src/domains/invoicing/services/bill.service.ts` — nested includes + taxRateId validation
- `apps/api/src/domains/invoicing/services/invoice.service.ts` — nested includes + taxRateId validation
- `apps/api/src/domains/invoicing/services/__tests__/bill.service.test.ts` — 3 new taxRateId tests
- `apps/api/src/domains/invoicing/services/__tests__/invoice.service.test.ts` — 3 new taxRateId tests
- `apps/web/src/components/line-item-builder.tsx` — tax rate dropdown + auto-calculation
- `apps/web/src/components/business/InvoiceForm.tsx` — fetch tax rates, pass to builder
- `apps/web/src/components/business/BillForm.tsx` — fetch tax rates, pass to builder

## Commits Made
- `ccabe18` feat(invoicing): wire tax rate dropdown to invoice/bill line items (FIN-26, UX-102)

## Bugs Fixed / Issues Hit
- **`replace_all` partial match (FIN-26 carryover):** Previous session's `replace_all` for `billLines: true,` (with trailing comma) only matched 2 of 9 occurrences. The other 7 had `billLines: true` as the last property before `}` (no trailing comma). Fixed by using the full inline pattern `include: { vendor: true, entity: true, billLines: true },` which matched all remaining occurrences.
- **Server-only import in client component:** Initially imported `listTaxRates` from `@/lib/api/accounting` which chains through `apiClient` (server-only). This would crash in `'use client'` components. Fixed by using `apiFetch` from `@/lib/api/client-browser` directly with the endpoint URL string.

## Patterns Discovered
- **Browser-side API client for forms:** When client components need to fetch data on mount, use `apiFetch` from `@/lib/api/client-browser` directly — NOT the typed API functions from `@/lib/api/*` which use server-only `apiClient`. The typed functions are only safe in Server Components.
- **Graceful tax rate fallback:** `catch(() => setTaxRates([]))` means the LineItemBuilder gets no `taxRates` prop data, which hides the dropdown column entirely — seamless degradation.

## Unfinished Work
None — both FIN-26 and UX-102 are complete.

## Self-Reflection (AI Agent Quality Check)

### Did I Follow the Pre-Flight Checklist?
- [x] Checked task availability (Step 0) before implementation
- [x] Read existing files before editing (never edited blindly)
- [x] Searched for patterns via Grep before creating new code
- [x] Used offset/limit for large files (>300 lines)
- [x] Verified patterns with Grep (didn't claim patterns without proof)
- [x] Searched MEMORY topic files before implementing

### Did I Violate Any Invariants?
- [x] All queries included tenantId filter
- [x] All money fields used integer cents (no floats)
- [x] All financial records soft-deleted (no hard deletes)
- [x] All page.tsx files have loading.tsx + error.tsx
- [x] No mixing server imports with 'use client'
- [x] Used design tokens (no hardcoded colors)
- [x] Used request.log/server.log (no console.log in production)
- [x] No `: any` types (used specific types or unknown)

### Loops or Repeated Mistakes Detected?
None — session was clean and efficient.

### Context Efficiency Score (Self-Grade)
- **File reads:** Efficient (used Explore agents for discovery, targeted reads for implementation)
- **Pattern verification:** Always verified (Grep before creating)
- **Memory usage:** Checked topic files via plan exploration
- **Overall grade:** A (efficient)

## Artifact Update Hints
- TASKS.md: Mark FIN-26 and UX-102 as done with commit `ccabe18`
- MEMORY.md: Add pattern about browser-side vs server-side API clients in forms
