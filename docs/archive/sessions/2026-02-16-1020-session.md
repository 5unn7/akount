# Session Summary — 2026-02-16 10:20

## What Was Done
- Verified Phase 4 E2E flow: invoice → payment allocation → GL posting
- Discovered 3 of 4 "pending" tasks were already complete (loading/error states, service tests, frontend forms)
- Added missing `POST /payments/:id/allocations/:allocationId/post` route — the one gap in the E2E chain
- Fixed 6 pre-existing test failures: 4 vi.mock hoisting errors (route tests) + 2 tenant isolation assertion mismatches (service tests)
- All 720 backend tests passing (was 600/602 with 6 file-level failures)
- Updated TASKS.md — Phase 4 marked COMPLETE, code review fixes marked COMPLETE (5/5)

## Files Changed
- `apps/api/src/domains/invoicing/routes/payments.ts` — added GL posting route + imports
- `apps/api/src/domains/invoicing/schemas/payment.schema.ts` — added PostPaymentAllocationSchema
- `apps/api/src/domains/clients/routes/__tests__/clients.routes.test.ts` — vi.hoisted() fix
- `apps/api/src/domains/clients/services/__tests__/client.service.test.ts` — tenant isolation assertion
- `apps/api/src/domains/invoicing/routes/__tests__/bills.routes.test.ts` — vi.hoisted() fix
- `apps/api/src/domains/invoicing/routes/__tests__/invoices.routes.test.ts` — vi.hoisted() fix
- `apps/api/src/domains/vendors/routes/__tests__/vendors.routes.test.ts` — vi.hoisted() fix
- `apps/api/src/domains/vendors/services/__tests__/vendor.service.test.ts` — tenant isolation assertion
- `TASKS.md` — Phase 4 + code review marked complete

## Commits Made
- `8bd9d2e` feat(api): Phase 4 E2E complete — payment GL posting route + test fixes

## Bugs Fixed / Issues Hit
- **vi.mock hoisting error** in 4 route test files: `const mockFn = vi.fn()` declared after `vi.mock()` which gets hoisted. Fix: wrap in `vi.hoisted(() => ({ ... }))`. Affects: clients, vendors, invoices, bills route tests.
- **Tenant isolation assertion mismatch** in client/vendor service tests: Services were correctly updated to include `entity: { tenantId }` in invoice/bill count queries, but tests didn't expect it. Fix: added the field to test expectations.

## Patterns Discovered
- **vi.hoisted() is required** when mock variable declarations are referenced inside `vi.mock()` factory functions. This is a vitest-specific pattern — `vi.mock()` is hoisted to file top, so any variables it references must also be hoisted.

## Unfinished Work
- None — Phase 4 is complete. Ready for Phase 5.
- Remaining unstaged deletions (`.agent/` workflows, temp files) and untracked files (`brand/`, `fx-rate.service.ts`) are from previous sessions and not related to this work.

## Artifact Update Hints
- TASKS.md already updated this session
- ROADMAP.md may need Phase 4 status update (currently might say "IN PROGRESS")
- STATUS.md needs Phase 4 completion update + test count (720)
- MEMORY.md: vi.hoisted() pattern worth noting in codebase-quirks.md
