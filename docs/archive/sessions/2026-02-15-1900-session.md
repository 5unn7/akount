# Session Summary — 2026-02-15 19:00

## What Was Done
- Fixed API server crash on startup (Zod `.partial()` on `ZodEffects`)
- Fixed new-user onboarding redirect flow (missing page + error classification bug)
- Removed all mock/hardcoded data from 7 dashboard widgets — new users now see clean empty states
- Fixed onboarding `/complete` endpoint crash on re-run (GL account unique constraint)

## Files Changed
- `apps/api/src/domains/invoicing/schemas/invoice.schema.ts` — extracted base schema for `.partial()`
- `apps/api/src/domains/invoicing/schemas/bill.schema.ts` — same fix
- `apps/api/src/domains/system/routes/onboarding.ts` — idempotent GL account creation
- `apps/web/src/app/(dashboard)/layout.tsx` — replaced `apiClient` with direct `fetch` for onboarding status
- `apps/web/src/app/(dashboard)/overview/page.tsx` — removed hardcoded trend data
- `apps/web/src/app/onboarding/page.tsx` — **created** (was missing, caused 404)
- `apps/web/src/app/onboarding/loading.tsx` — **created**
- `apps/web/src/app/onboarding/error.tsx` — **created**
- `apps/web/src/components/dashboard/ActionItems.tsx` — removed MOCK_ITEMS, added empty state
- `apps/web/src/components/dashboard/UpcomingPayments.tsx` — removed MOCK_PAYMENTS, added empty state
- `apps/web/src/components/dashboard/QuickStats.tsx` — removed MOCK_STATS, added empty state
- `apps/web/src/components/dashboard/AIBrief.tsx` — removed hardcoded financial narrative, added welcome message
- `apps/web/src/components/dashboard/ExpenseChart.tsx` — removed generateMockData(), added empty state
- `apps/web/src/components/dashboard/CashFlowChart.tsx` — removed generateMockData(), added empty state

## Commits Made
- `f31172a` fix: Zod UpdateSchema partial() on refined schemas + layout onboarding fetch
- (uncommitted) mock data removal + onboarding idempotency fix

## Bugs Fixed / Issues Hit

### Bug 1: API crash — `CreateInvoiceSchema.partial is not a function`
- **Root cause:** `.partial()` called on `ZodEffects` (result of `.refine()`) — only works on `ZodObject`
- **Fix:** Extracted `CreateInvoiceBaseSchema` as plain `z.object()`, used that for `.partial()`
- **Also in:** bill.schema.ts (same pattern)

### Bug 2: New users see "API Server Unavailable" instead of onboarding
- **Root cause 1:** Missing `/onboarding/page.tsx` — only `components/` and `complete/page.tsx` existed
- **Root cause 2:** `checkOnboardingStatus()` used `apiClient` which replaces error messages with response body — so `error.message.startsWith('API error:')` never matched, causing 404 (user not in DB) to be classified as "network error"
- **Fix:** Created missing page, replaced `apiClient` with direct `fetch` for proper HTTP vs network error distinction

### Bug 3: Dashboard showing fake data to new users
- **Root cause:** 7 dashboard widgets had hardcoded mock data arrays as fallbacks
- **Fix:** Replaced all mock fallbacks with empty state UI (icons + helpful messages)

### Bug 4: Onboarding `/complete` crashes on re-run
- **Root cause:** `GLAccount.create()` in a loop fails on `@@unique([entityId, code])` when accounts already exist
- **Fix:** Changed to `createMany({ skipDuplicates: true })` — endpoint now idempotent

## Patterns Discovered
- **Zod `.refine()` breaks `.partial()`**: When a schema uses `.refine()`, it becomes `ZodEffects` which doesn't have `.partial()`. Always extract a base `z.object()` first, then apply `.refine()` separately. Use the base for `.partial()`.
- **`apiClient` wrapper obscures HTTP errors**: The `apiClient` replaces error messages with JSON body's `message` field, making it impossible to distinguish HTTP errors from network errors. For cases where this distinction matters, use direct `fetch`.
- **Onboarding flow not designed for re-entry**: "Add entity" from nav redirects to `/onboarding` which tries `/initialize` → fails with "AlreadyOnboarded" → recovery path sets `entityId: 'existing'` → `/complete` re-runs. This works now but is fragile — needs a proper "add entity" flow separate from onboarding.

## Unfinished Work
- All changes are uncommitted — need to commit the mock data removal + onboarding fixes
- The "add entity" UX still routes through onboarding wizard instead of a dedicated entity creation flow — product design issue, not a bug (now that `/complete` is idempotent)

## Artifact Update Hints
- `MEMORY.md` debugging-log.md — Zod `.refine()` + `.partial()` gotcha, apiClient error classification issue
- `apps/web/CLAUDE.md` — onboarding route files now exist
- No TASKS.md changes (these were bug fixes, not planned tasks)
